# üöÄ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ - –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### **–ü—Ä–∏–Ω—Ü–∏–ø—ã:**

- ‚úÖ –ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –ª–æ–≥–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–≤ Route Handlers)
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å cookies
- ‚úÖ –ú–∏–Ω–∏–º—É–º –∫–æ–¥–∞ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **`/api/[entity]`** - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
2. **`TokenManager`** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
3. **`base.ts`** - —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è Server Components
4. **`/api/auth/refresh`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### **–§–ª–æ—É –∑–∞–ø—Ä–æ—Å–∞:**

```
Server Component ‚Üí base.ts ‚Üí /api/[entity] ‚Üí TokenManager ‚Üí /api/auth/refresh ‚Üí –±—ç–∫–µ–Ω–¥
```

### **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏:**

- –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ö–æ—Ç—è—Ç refresh - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry:**

- –ü—Ä–∏ 401 –æ—à–∏–±–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
app/api/
‚îú‚îÄ‚îÄ [entity]/route.ts          # üÜï –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
‚îî‚îÄ‚îÄ auth/refresh/route.ts      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

lib/auth/
‚îú‚îÄ‚îÄ token-manager.ts           # ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
‚îú‚îÄ‚îÄ actions.ts                 # Server Actions –¥–ª—è cookies
‚îú‚îÄ‚îÄ utils.ts                   # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
‚îî‚îÄ‚îÄ types.ts                   # TypeScript —Ç–∏–ø—ã

lib/server-data/
‚îú‚îÄ‚îÄ base.ts                    # ‚úÖ –°–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è Server Components
‚îî‚îÄ‚îÄ types.ts                   # –¢–∏–ø—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

lib/projects/
‚îî‚îÄ‚îÄ server.ts                  # ‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤

app/
‚îî‚îÄ‚îÄ page.tsx                   # ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### **1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API**

```typescript
// app/api/[entity]/route.ts
export async function GET(request, { params }) {
  const entity = params.entity; // projects, users, tasks, etc.

  // –í—Å—è –ª–æ–≥–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
  const tokens = await tokenManager.getValidTokens();
  // ...
}
```

### **2. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤**

```typescript
// lib/auth/token-manager.ts
class TokenManager {
  private isRefreshing = false;
  private refreshPromise: Promise<AuthTokens | null> | null = null;

  async refreshTokens() {
    if (this.isRefreshing && this.refreshPromise) {
      // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ refresh
      return await this.refreshPromise;
    }
    // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π refresh
  }
}
```

### **3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry**

```typescript
// app/api/[entity]/route.ts
if (response.status === 401) {
  const newTokens = await tokenManager.refreshTokens();
  if (newTokens) {
    // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
    const retryResponse = await fetch(url, {
      headers: { Authorization: `Bearer ${newTokens.accessToken}` },
    });
  }
}
```

### **4. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

```typescript
// app/page.tsx
async function ProjectsPageContent() {
  // –ü—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ - –≤—Å—è –ª–æ–≥–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ API
  const data = await projectsServerProvider.getProjects(params);
  return <ProjectsList initialData={data} />;
}
```

## üöÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É—â–Ω–æ—Å—Ç–∏

### **–®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä**

```typescript
// lib/tasks/server.ts
export class TasksServerProvider extends ServerDataProvider<Task> {
  constructor() {
    super("/api/tasks"); // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API
  }
}
```

### **–®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø—ã**

```typescript
// lib/tasks/types.ts
export interface Task {
  id: string;
  title: string;
  // ...
}
```

### **–®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**

```typescript
// app/tasks/page.tsx
const tasks = await tasksServerProvider.getTasks(params);
```

**–í–æ—Ç –∏ –≤—Å–µ!** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã.

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### **1. –ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –ª–æ–≥–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤**

- ‚úÖ –í—Å—è –ª–æ–≥–∏–∫–∞ –≤ `/api/[entity]`
- ‚úÖ TokenManager —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Route Handler –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- ‚úÖ Cookies —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º

### **2. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤**

- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω refresh –∑–∞–ø—Ä–æ—Å –¥–∞–∂–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ refresh
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### **3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry**

- ‚úÖ –ü—Ä–∏ 401 –æ—à–∏–±–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### **4. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

- ‚úÖ –û–¥–∏–Ω –º–µ—Ç–æ–¥ `getValidTokens()` –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –¥—É–º–∞—Ç—å –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases

### **5. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**

- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- ‚úÖ –ú–∏–Ω–∏–º—É–º –∫–æ–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –∏ SSR

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ—Å—Ç 1: –ì–æ–Ω–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**

1. –£–¥–∞–ª–∏—Ç–µ `accessToken` cookie
2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫—Ä–æ–π—Ç–µ 3 –≤–∫–ª–∞–¥–∫–∏ —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ `/api/authentication/refresh-tokens`
4. **–õ–æ–≥–∏**: `[TokenManager] Refresh already in progress, waiting...`

### **–¢–µ—Å—Ç 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry**

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π `accessToken`
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–æ–≤
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
4. **–õ–æ–≥–∏**: `[projects API] Got 401, refreshing tokens and retrying...`

### **–¢–µ—Å—Ç 3: Refresh token –∏—Å—Ç–µ–∫**

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π `refreshToken`
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–æ–≤
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: Redirect –Ω–∞ `/login`
4. **–õ–æ–≥–∏**: `[TokenManager] Token refresh failed`

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ–ª—É—á–∏–ª–∞—Å—å –ø—Ä–æ—Å—Ç–∞—è, –Ω–∞–¥–µ–∂–Ω–∞—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞:**

- ‚úÖ **–ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –ª–æ–≥–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤** - –≤ Route Handlers
- ‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API** –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å cookies** - –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤** - singleton pattern
- ‚úÖ **–ú–∏–Ω–∏–º—É–º –∫–æ–¥–∞ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è** - –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry** - –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ
- ‚úÖ **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –¥–ª—è Server –∏ Client –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## üîß –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–º–µ—é—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

- `[TokenManager]` - –ª–æ–≥–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏
- `[projects API]` - –ª–æ–≥–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤
- `[ProjectsServerProvider]` - –ª–æ–≥–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `[Page]` - –ª–æ–≥–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

## üéØ –ò—Ç–æ–≥

**–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –∏–¥–µ–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏:**

- –ü—Ä–æ—Å—Ç–∞—è –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- –ù–∞–¥–µ–∂–Ω–∞—è –≤ —Ä–∞–±–æ—Ç–µ
- –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∞—è —Å cookies
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∞—è –≥–æ–Ω–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ
