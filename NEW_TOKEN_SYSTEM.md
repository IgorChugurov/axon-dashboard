# üöÄ –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üìã –û–±–∑–æ—Ä —Ä–µ—à–µ–Ω–∏—è

–°–æ–∑–¥–∞–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ—à–∞–µ—Ç –≤—Å–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤** - —Ç–µ–ø–µ—Ä—å –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —á–µ—Ä–µ–∑ `TokenManager`
2. **–ü—Ä–æ–±–ª–µ–º–∞ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤** - singleton pattern –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ refresh
3. **–ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –º–µ—Ö–∞–Ω–∏–∑–º
4. **–û—à–∏–±–∫–∏ —Å –∫—É–∫–∞–º–∏** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
5. **–°—Ç—Ä–∞–Ω–Ω—ã–π refresh –≤ API –ø—Ä–æ–µ–∫—Ç–æ–≤** - —É–±—Ä–∞–Ω, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TokenManager

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### **TokenManager** - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

**–§–∞–π–ª**: `lib/auth/token-manager.ts`

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

- ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤** - –µ—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç refresh, –∂–¥–µ—Ç –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry** - –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
- ‚úÖ **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –≤—Å–µ refresh –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –º–µ—Ö–∞–Ω–∏–∑–º
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** - –æ–¥–∏–Ω –º–µ—Ç–æ–¥ `getValidTokens()` –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```typescript
// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
await tokenManager.getValidTokens();

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry –ø—Ä–∏ 401
await tokenManager.requestWithRetry(async (tokens) => {
  return await fetch(url, {
    headers: { Authorization: `Bearer ${tokens.accessToken}` },
  });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è refresh token
await tokenManager.hasRefreshToken();
```

### **ImprovedServerApiClient** - –£–ª—É—á—à–µ–Ω–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç

**–§–∞–π–ª**: `lib/auth/improved-server-api-client.ts`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TokenManager` –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π retry –º–µ—Ö–∞–Ω–∏–∑–º

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**

1. **`lib/server-data/base.ts`** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `TokenManager.requestWithRetry()`
2. **`app/page.tsx`** - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ `tokenManager.getValidTokens()`
3. **`app/api/projects/route.ts`** - —É–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ refresh

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞**

```
1. Page/Component –≤—ã–∑—ã–≤–∞–µ—Ç tokenManager.getValidTokens()
2. TokenManager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
3. –ï—Å–ª–∏ access token –≤–∞–ª–∏–¥–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã
4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –¥–ª—è API –∑–∞–ø—Ä–æ—Å–∞
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: Access token –∏—Å—Ç–µ–∫**

```
1. Page/Component –≤—ã–∑—ã–≤–∞–µ—Ç tokenManager.getValidTokens()
2. TokenManager –≤–∏–¥–∏—Ç —á—Ç–æ access token –∏—Å—Ç–µ–∫
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –∏–¥–µ—Ç –ª–∏ —É–∂–µ refresh? ‚Üí –ù–ï–¢
4. –í—ã–∑—ã–≤–∞–µ—Ç refreshAuthTokens() (Server Action)
5. Server Action –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ cookies
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
7. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–µ–∂–∏–µ —Ç–æ–∫–µ–Ω—ã
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ì–æ–Ω–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞)**

```
1. –ó–∞–ø—Ä–æ—Å A: tokenManager.getValidTokens() ‚Üí –≤–∏–¥–∏—Ç –∏—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω
2. –ó–∞–ø—Ä–æ—Å B: tokenManager.getValidTokens() ‚Üí –≤–∏–¥–∏—Ç —á—Ç–æ —É–∂–µ –∏–¥–µ—Ç refresh
3. –ó–∞–ø—Ä–æ—Å C: tokenManager.getValidTokens() ‚Üí –≤–∏–¥–∏—Ç —á—Ç–æ —É–∂–µ –∏–¥–µ—Ç refresh
4. –ó–∞–ø—Ä–æ—Å A: –Ω–∞—á–∏–Ω–∞–µ—Ç refresh, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ isRefreshing = true
5. –ó–∞–ø—Ä–æ—Å—ã B –∏ C: –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è refresh –æ—Ç A
6. Refresh –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
7. ‚úÖ –¢–æ–ª—å–∫–æ –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 4: 401 –æ—à–∏–±–∫–∞ –æ—Ç API**

```
1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç API –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ tokenManager.requestWithRetry()
2. –ü–æ–ª—É—á–∞–µ—Ç 401 –æ—Ç–≤–µ—Ç –æ—Ç –±—ç–∫–µ–Ω–¥–∞
3. TokenManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç refresh
4. –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
5. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
7. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ—à–∏–±–∫—É - –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 5: Refresh token –∏—Å—Ç–µ–∫**

```
1. TokenManager –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
2. –ë—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400/401 (refresh token –∏—Å—Ç–µ–∫)
3. refreshAuthTokens() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null
4. TokenManager –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null
5. Page component –¥–µ–ª–∞–µ—Ç redirect("/login")
6. Middleware –æ—á–∏—â–∞–µ—Ç cookies
7. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ª–æ–≥–∏–Ω
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
lib/auth/
‚îú‚îÄ‚îÄ token-manager.ts              # üÜï –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ improved-server-api-client.ts # üÜï –£–ª—É—á—à–µ–Ω–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ actions.ts                    # Server Actions (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îú‚îÄ‚îÄ utils.ts                      # –£—Ç–∏–ª–∏—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îú‚îÄ‚îÄ types.ts                      # –¢–∏–ø—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îî‚îÄ‚îÄ server-auth.ts                # –°—Ç–∞—Ä—ã–π –∫–ª–∞—Å—Å (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)

lib/server-data/
‚îî‚îÄ‚îÄ base.ts                       # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TokenManager

app/
‚îú‚îÄ‚îÄ page.tsx                      # ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îî‚îÄ‚îÄ api/projects/route.ts         # ‚úÖ –£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### **1. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤**

- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω refresh –∑–∞–ø—Ä–æ—Å –¥–∞–∂–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ refresh
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### **2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry**

- ‚úÖ –ü—Ä–∏ 401 –æ—à–∏–±–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### **3. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

- ‚úÖ –û–¥–∏–Ω –º–µ—Ç–æ–¥ `getValidTokens()` –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –¥—É–º–∞—Ç—å –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases

### **4. –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

- ‚úÖ –í—Å—è –ª–æ–≥–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### **5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

- ‚úÖ HttpOnly cookies –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏
- ‚úÖ Server Actions –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ cookies –∏–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ—Å—Ç 1: –ì–æ–Ω–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**

1. –£–¥–∞–ª–∏—Ç–µ `accessToken` cookie
2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫—Ä–æ–π—Ç–µ 3 –≤–∫–ª–∞–¥–∫–∏ —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ `/api/authentication/refresh-tokens`
4. **–õ–æ–≥–∏**: `[TokenManager] Refresh already in progress, waiting...`

### **–¢–µ—Å—Ç 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry**

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π `accessToken`
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–æ–≤
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
4. **–õ–æ–≥–∏**: `[TokenManager] Got 401, refreshing tokens and retrying...`

### **–¢–µ—Å—Ç 3: Refresh token –∏—Å—Ç–µ–∫**

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π `refreshToken`
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–æ–≤
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: Redirect –Ω–∞ `/login`
4. **–õ–æ–≥–∏**: `[TokenManager] Token refresh failed`

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è

### **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

1. **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**

   - `lib/auth/token-manager.ts`
   - `lib/auth/improved-server-api-client.ts`

2. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

   - `lib/server-data/base.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TokenManager
   - `app/page.tsx` - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
   - `app/api/projects/route.ts` - —É–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

3. **–ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:**
   - `lib/auth/server-auth.ts` - –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ TokenManager
   - `lib/auth/server-api-client.ts` - –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ ImprovedServerApiClient

### **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

```typescript
// –í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞:
const tokens = await getAuthTokens();
if (!tokens || isTokenExpired(tokens.expiresAt)) {
  const newTokens = await refreshAuthTokens();
  // ...
}

// –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ:
const tokens = await tokenManager.getValidTokens();
if (!tokens) {
  redirect("/login");
}
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ –≥–æ–Ω–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ—à–µ–Ω–∞** - singleton pattern –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ refresh  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è  
‚úÖ **–û—à–∏–±–∫–∏ —Å –∫—É–∫–∞–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏  
‚úÖ **–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–æ—â–µ–Ω–∞** - –æ–¥–∏–Ω –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤  
‚úÖ **–ö–æ–¥ —Å—Ç–∞–ª —á–∏—â–µ** - —É–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

**–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ—Å—Ç–∞—è, –Ω–∞–¥–µ–∂–Ω–∞—è –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏!** üöÄ
