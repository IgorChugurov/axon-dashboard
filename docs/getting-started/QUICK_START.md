# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç - –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ Server Actions —Ä–µ—à–µ–Ω–∞**

- –£–±—Ä–∞–Ω—ã –≤—ã–∑–æ–≤—ã `clearAuthCookies()` –∏–∑ `refreshAuthTokens()`
- –û—á–∏—Å—Ç–∫–∞ cookies —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –≤ page.tsx –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

- Server Actions –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç cookies
- Server Components —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç –∏ –≤—ã–∑—ã–≤–∞—é—Ç Server Actions
- –ù–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

### 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env.local`

–§–∞–π–ª —É–∂–µ —Å–æ–∑–¥–∞–Ω, –Ω–æ –≤–∞–º –Ω—É–∂–Ω–æ **–∑–∞–º–µ–Ω–∏—Ç—å URL –±—ç–∫–µ–Ω–¥–∞**:

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª
nano .env.local

# –ò–ª–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
code .env.local
```

–ó–∞–º–µ–Ω–∏—Ç–µ `https://your-backend-api.com` –Ω–∞ **—Ä–µ–∞–ª—å–Ω—ã–π URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞**:

```bash
# –ü—Ä–∏–º–µ—Ä:
NEXT_PUBLIC_API_URL=https://api.myproject.com

# –ò–ª–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
NEXT_PUBLIC_API_URL=http://localhost:8000
```

**–í–∞–∂–Ω–æ**: URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ë–ï–ó trailing slash –∏ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –∫–æ—Ä–µ–Ω—å API.

–í–∞—à –±—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å endpoint:

```
POST {NEXT_PUBLIC_API_URL}/api/authentication/refresh-tokens
Body: { "refreshToken": "..." }
Response: { "accessToken": "...", "refreshToken": "...", "exp": 1234567890, "email": "..." }
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä (Ctrl+C)

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
pnpm dev
```

**–í–∞–∂–Ω–æ**: `.env.local` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞!

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Application ‚Üí Cookies
2. –£–¥–∞–ª–∏—Ç–µ —Ç–æ–ª—å–∫–æ `accessToken` cookie
3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:
     ```
     [Page] Tokens expired or missing, refreshing...
     [ServerAction] Refreshing tokens...
     [ServerAction] Tokens refreshed successfully
     ```
   - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
   - –ù–æ–≤—ã–π `accessToken` –ø–æ—è–≤–∏–ª—Å—è –≤ cookies

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Redirect –Ω–∞ –ª–æ–≥–∏–Ω

1. –£–¥–∞–ª–∏—Ç–µ –í–°–ï auth cookies –≤ DevTools
2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login`
   - –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ –ª–æ–≥–∞—Ö

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏:

```
[Page] Tokens expired or missing, refreshing...
[ServerAction] Refreshing tokens...
[ServerAction] Backend URL: https://your-backend-api.com
[ServerAction] Tokens refreshed successfully
[Page] Loading projects...
```

### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏ (–æ—à–∏–±–∫–∏):

```
[ServerAction] Refresh failed: 404 Not Found
```

‚Üí **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `NEXT_PUBLIC_API_URL` –≤ `.env.local`

```
Error: Cookies can only be modified in a Server Action or Route Handler
```

‚Üí **–†–µ—à–µ–Ω–∏–µ**: –≠—Ç–∞ –æ—à–∏–±–∫–∞ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ - –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥.

```
[ServerAction] No refresh token found
```

‚Üí **–†–µ—à–µ–Ω–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç redirect –Ω–∞ `/login`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```
–ó–∞–ø—Ä–æ—Å ‚Üí Middleware (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
            ‚Üì
      Page Component
            ‚Üì
      getAuthTokens() [—á—Ç–µ–Ω–∏–µ]
            ‚Üì
      isTokenExpired()?
       ‚Üì         ‚Üì
      –î–ê        –ù–ï–¢ ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
       ‚Üì
  refreshAuthTokens() [Server Action - –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø]
       ‚Üì
  –£—Å–ø–µ—Ö? ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  –ù–µ—É–¥–∞—á–∞ ‚Üí clearAuthCookies() + redirect("/login")
```

## –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ

- `lib/auth/actions.ts` - Server Actions (–ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø cookies)
- `lib/auth/utils.ts` - –£—Ç–∏–ª–∏—Ç—ã (–ß–¢–ï–ù–ò–ï cookies)
- `app/page.tsx` - –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `.env.local` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ù–£–ñ–ù–û –ù–ê–°–¢–†–û–ò–¢–¨!)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `AUTH_ARCHITECTURE_SPEC.md` - –ü–æ–ª–Ω–æ–µ –¢–ó
- `FINAL_IMPLEMENTATION_SUMMARY.md` - –†–µ–∑—é–º–µ
- `QUICK_START.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. "404 Not Found" –ø—Ä–∏ refresh

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –±—ç–∫–µ–Ω–¥–∞ –≤ `.env.local`

**–†–µ—à–µ–Ω–∏–µ**:

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª
cat .env.local

# –ó–∞–º–µ–Ω–∏—Ç–µ URL
echo "NEXT_PUBLIC_API_URL=https://your-real-backend.com" > .env.local

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
pnpm dev
```

### 2. "Cookies can only be modified..."

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–æ–ø—ã—Ç–∫–∞ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å cookies –≤–Ω–µ Server Action

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞. –ü—Ä–æ–±–ª–µ–º–∞ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞.

### 3. –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login

**–ü—Ä–∏—á–∏–Ω–∞**: Middleware —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç ‚Üí –ª–æ–≥–∏–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí —Å–Ω–æ–≤–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `/login` –∏—Å–∫–ª—é—á–µ–Ω –≤ middleware.ts:

```typescript
if (pathname.startsWith("/login") || ...) {
  return NextResponse.next();
}
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env.local` —Å —Ä–µ–∞–ª—å–Ω—ã–º URL –±—ç–∫–µ–Ω–¥–∞
2. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env.local` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ URL?
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ –ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env.local`?
3. –ï—Å—Ç—å –ª–∏ —É –±—ç–∫–µ–Ω–¥–∞ endpoint `/api/authentication/refresh-tokens`?
4. –ö–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±—ç–∫–µ–Ω–¥? (—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö)

---

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ
