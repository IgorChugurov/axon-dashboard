# –ê–Ω–∞–ª–∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Auth SDK

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

## üìã –†–µ–∑—é–º–µ

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ `packages/auth-sdk`, –Ω–æ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å.

## ‚úÖ –ß—Ç–æ —É–∂–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ SDK

1. **Middleware** - `middleware.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `createAuthMiddleware` –∏–∑ SDK ‚úÖ
2. **AuthProvider** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SDK –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚úÖ
3. **–¢–∏–ø—ã** - `lib/auth/headers.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø—ã –∏–∑ SDK ‚úÖ
4. **Supabase –∫–ª–∏–µ–Ω—Ç—ã** - SDK –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `createServerSupabaseClient` –∏ `createBrowserSupabaseClient` ‚úÖ

## ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –î—É–±–ª–∏–∫–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

#### 1.1. `lib/auth/roles.ts` vs `packages/auth-sdk/src/server/role-service.ts`

**–°—Ç–∞—Ç—É—Å:** –î–£–ë–õ–ò–ö–ê–¢

**–§–∞–π–ª:** `lib/auth/roles.ts`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- `app/projects/[projectId]/[entityDefId]/fields/[fieldId]/page.tsx`
- `app/projects/[projectId]/[entityDefId]/fields/new/page.tsx`
- `app/projects/[projectId]/[entityDefId]/edit/page.tsx`
- `app/projects/[projectId]/new/page.tsx`
- `app/projects/[projectId]/[entityDefId]/entity-definition-actions.ts`
- `app/projects/[projectId]/[entityDefId]/fields/page.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –§—É–Ω–∫—Ü–∏–∏ `getUserRole()`, `isAdmin()`, `isSuperAdmin()` –¥—É–±–ª–∏—Ä—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–∑ SDK
- SDK –≤–µ—Ä—Å–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `SupabaseClient` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä, —á—Ç–æ –±–æ–ª–µ–µ –≥–∏–±–∫–æ
- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `createClient()` –∏–∑ `lib/supabase/server` –≤–Ω—É—Ç—Ä–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –ó–∞–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ SDK –≤–µ—Ä—Å–∏—é
- –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã: `isAdmin(userId)` ‚Üí `isAdmin(supabase, userId)`

#### 1.2. `lib/auth/role-cache.ts` vs `packages/auth-sdk/src/utils/role-cache.ts`

**–°—Ç–∞—Ç—É—Å:** –î–£–ë–õ–ò–ö–ê–¢

**–§–∞–π–ª:** `lib/auth/role-cache.ts`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `lib/auth/roles.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ü–æ–ª–Ω—ã–π –¥—É–±–ª–∏–∫–∞—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- SDK –≤–µ—Ä—Å–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `CookieHandler` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `NextRequest`/`NextResponse` –Ω–∞–ø—Ä—è–º—É—é

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ `lib/auth/roles.ts` –Ω–∞ SDK

#### 1.3. `lib/auth/types.ts` vs `packages/auth-sdk/src/types.ts`

**–°—Ç–∞—Ç—É—Å:** –ß–ê–°–¢–ò–ß–ù–´–ô –î–£–ë–õ–ò–ö–ê–¢

**–§–∞–π–ª:** `lib/auth/types.ts`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- `components/providers/AuthProvider.tsx` - –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `User` —Ç–∏–ø

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –¢–∏–ø—ã `User`, `UserRole` –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è
- SDK –≤–µ—Ä—Å–∏—è –±–æ–ª–µ–µ –ø–æ–ª–Ω–∞—è –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è
- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–∏–ø—ã (`AuthTokens`, `AuthState`, `LoginResponse` –∏ —Ç.–¥.)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –ó–∞–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç –≤ `AuthProvider.tsx` –Ω–∞ SDK –≤–µ—Ä—Å–∏—é
- –£–¥–∞–ª–∏—Ç—å `lib/auth/types.ts` –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

#### 1.4. `lib/supabase/middleware.ts` vs `packages/auth-sdk/src/server/middleware.ts`

**–°—Ç–∞—Ç—É—Å:** –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø

**–§–∞–π–ª:** `lib/supabase/middleware.ts`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∏–≥–¥–µ –≤ –∫–æ–¥–µ
- `middleware.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SDK –≤–µ—Ä—Å–∏—é

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- ‚úÖ –£–î–ê–õ–ò–¢–¨ —Ñ–∞–π–ª

### 2. –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∫–æ–¥ (–Ω–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ SDK)

#### 2.1. `lib/auth/utils.ts`

**–°—Ç–∞—Ç—É—Å:** –õ–ï–ì–ê–°–ò –ö–û–î (–¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- `lib/api/handlers.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `getAuthTokens()`

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ö–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ (–Ω–µ Supabase)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º API (`NEXT_PUBLIC_API_URL`)
- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å cookies: `accessToken`, `refreshToken`, `userData`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- ‚ö†Ô∏è –û–°–¢–ê–í–ò–¢–¨ - —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º API
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ `lib/api/auth-utils.ts` –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏

#### 2.2. `lib/auth/headers.ts`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢ SDK

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- `app/layout.tsx`
- `app/page.tsx`
- `lib/entities/projects/service.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**

- ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø—ã –∏–∑ SDK (`@/packages/auth-sdk/src/types`)
- –§—É–Ω–∫—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞ –¥–ª—è Next.js (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `next/headers`)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- ‚úÖ –û–°–¢–ê–í–ò–¢–¨ - —ç—Ç–æ –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Next.js

#### 2.3. `lib/supabase/server.ts` –∏ `lib/supabase/client.ts`

**–°—Ç–∞—Ç—É—Å:** –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í–ï–ó–î–ï

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `createClient()` –∏–∑ —ç—Ç–∏—Ö —Ñ–∞–π–ª–æ–≤
- SDK –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `createServerSupabaseClient()` –∏ `createBrowserSupabaseClient()`

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –°—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ–ª–µ–µ —É–¥–æ–±–Ω—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ–¥–∞—á–∏ URL –∏ –∫–ª—é—á–∞)
- SDK –≤–µ—Ä—Å–∏–∏ —Ç—Ä–µ–±—É—é—Ç —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- ‚ö†Ô∏è –û–°–¢–ê–í–ò–¢–¨ –∫–∞–∫ –æ–±–µ—Ä—Ç–∫–∏ –Ω–∞–¥ SDK –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- –ò–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –Ω–∞ SDK –≤–µ—Ä—Å–∏–∏

### 3. –§–∞–π–ª—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏

#### 3.1. `app/auth/callback/route.ts`

**–°—Ç–∞—Ç—É—Å:** –ú–û–ñ–ù–û –£–õ–£–ß–®–ò–¢–¨

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```typescript
import { createClient } from "@/lib/supabase/server";
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±–µ—Ä—Ç–∫—É)
- –ò–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ SDK –≤–µ—Ä—Å–∏—é –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –§–∞–π–ª—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:

- ‚ùå `lib/supabase/middleware.ts` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### –§–∞–π–ª—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ SDK:

- ‚ö†Ô∏è `lib/auth/roles.ts` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ SDK –≤–µ—Ä—Å–∏—é (6 –º–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- ‚ö†Ô∏è `lib/auth/role-cache.ts` - —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ roles.ts
- ‚ö†Ô∏è `lib/auth/types.ts` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ SDK –≤–µ—Ä—Å–∏—é (1 –º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

### –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å:

- ‚úÖ `lib/auth/utils.ts` - —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API
- ‚úÖ `lib/auth/headers.ts` - –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è Next.js, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SDK —Ç–∏–ø—ã
- ‚úÖ `lib/supabase/server.ts` - –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- ‚úÖ `lib/supabase/client.ts` - –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞

1. ‚úÖ –£–¥–∞–ª–∏—Ç—å `lib/supabase/middleware.ts`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ SDK

1. –ó–∞–º–µ–Ω–∏—Ç—å `lib/auth/types.ts` –Ω–∞ SDK –≤–µ—Ä—Å–∏—é –≤ `AuthProvider.tsx`
2. –ó–∞–º–µ–Ω–∏—Ç—å `lib/auth/roles.ts` –Ω–∞ SDK –≤–µ—Ä—Å–∏—é –≤ 6 –º–µ—Å—Ç–∞—Ö
3. –£–¥–∞–ª–∏—Ç—å `lib/auth/role-cache.ts` –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ roles.ts
4. –£–¥–∞–ª–∏—Ç—å `lib/auth/types.ts` –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `lib/auth/utils.ts` ‚Üí `lib/api/auth-utils.ts`
2. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `lib/supabase/server.ts` –∏ `client.ts` –Ω–∞ SDK –≤–µ—Ä—Å–∏–∏

## üìù –î–µ—Ç–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ú–∏–≥—Ä–∞—Ü–∏—è `lib/auth/roles.ts` ‚Üí SDK

**–ë—ã–ª–æ:**

```typescript
import { isAdmin } from "@/lib/auth/roles";
// ...
const isUserAdmin = await isAdmin(userId);
```

**–°—Ç–∞–ª–æ:**

```typescript
import { isAdmin } from "@/packages/auth-sdk/src/server/role-service";
import { createClient } from "@/lib/supabase/server";
// ...
const supabase = await createClient();
const isUserAdmin = await isAdmin(supabase, userId);
```

### –ú–∏–≥—Ä–∞—Ü–∏—è `lib/auth/types.ts` ‚Üí SDK

**–ë—ã–ª–æ:**

```typescript
import type { User } from "@/lib/auth/types";
```

**–°—Ç–∞–ª–æ:**

```typescript
import type { User } from "@/packages/auth-sdk/src/types";
```

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ SDK. –û—Å—Ç–∞–ª–æ—Å—å:

- **1 —Ñ–∞–π–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è** (–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥)
- **3 —Ñ–∞–π–ª–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏** (–¥—É–±–ª–∏–∫–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)
- **4 —Ñ–∞–π–ª–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å** (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –æ–±–µ—Ä—Ç–∫–∏)

–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏: **~85%** ‚úÖ
