# –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ project_users

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Supabase Auth

- ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `auth.users` (Supabase Auth)
- ‚úÖ –û–¥–∏–Ω email = –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç –≤ —Å–∏—Å—Ç–µ–º–µ
- ‚úÖ –û–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (—Ç–∞–±–ª–∏—Ü–∞ `profiles`)

### 2. –ü—Ä–æ—Ñ–∏–ª–∏

- ‚úÖ **–û–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å** —Ä–∞—Å—à–∞—Ä–µ–Ω –ø–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- ‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `profiles` (—Å–≤—è–∑–∞–Ω —Å `auth.users.id`)
- ‚ùå –ù–ï –Ω—É–∂–Ω—ã —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

---

## üìã –ê–Ω–∞–ª–∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è project_users

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—É—â–Ω–æ—Å—Ç—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤—è–∑–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- –£ –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–∫–∏–º-—Ç–æ —Å—É—â–Ω–æ—Å—Ç—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥—Ä—É–≥–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é
- –ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∑–∞–∫–∞–∑—ã —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

**–ê–Ω–∞–ª–∏–∑:**

- ‚ùå –≠—Ç–æ **–ù–ï** –∑–∞–¥–∞—á–∞ `project_users`
- ‚úÖ –≠—Ç–æ –∑–∞–¥–∞—á–∞ **–æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å–≤—è–∑–µ–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user_company`, `user_organization`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**

```sql
-- –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–≤—è–∑–µ–π
CREATE TABLE user_company (
  user_id UUID REFERENCES auth.users(id),
  company_id UUID REFERENCES entity_instance(id),
  role TEXT,  -- 'member', 'admin', etc.
  UNIQUE(user_id, company_id)
);

-- –í RLS –ø–æ–ª–∏—Ç–∏–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ JOIN
CREATE POLICY "Users can view orders of their company"
  ON entity_instance FOR SELECT
  USING (
    entity_definition_id = 'orders-id'
    AND (
      -- –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ
      is_admin(auth.uid())
      OR
      -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∑–∞–∫–∞–∑—ã —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
      EXISTS (
        SELECT 1 FROM user_company uc
        JOIN entity_instance company ON uc.company_id = company.id
        WHERE uc.user_id = auth.uid()
          AND entity_instance.data->>'company_id' = company.id::text
      )
    )
  );
```

**–í—ã–≤–æ–¥:** `project_users` –ù–ï –Ω—É–∂–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è.

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–∫–∞–∑

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `entity_instance`
- –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ –∑–∞–∫–∞–∑—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (Owner|Admin)

**–ê–Ω–∞–ª–∏–∑:**

- ‚úÖ –≠—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `created_by` –≤ `entity_instance`
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `Owner|Admin` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `check_permission` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ —á–µ—Ä–µ–∑ `created_by`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```sql
-- entity_instance.created_by ‚Üí auth.users.id
-- RLS –ø–æ–ª–∏—Ç–∏–∫–∞:
CREATE POLICY "View orders"
  ON entity_instance FOR SELECT
  USING (
    check_permission(
      'Owner|Admin',  -- read_permission
      auth.uid(),
      entity_instance.created_by  -- owner_id
    )
  );
```

**–í—ã–≤–æ–¥:** `project_users` –ù–ï –Ω—É–∂–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ `created_by`.

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ç–æ–∫–µ–Ω–æ–º
- –£ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **–Ω–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**, —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Supabase, –Ω–æ **–Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é** –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ

**–ê–Ω–∞–ª–∏–∑:**

- ‚úÖ –≠—Ç–æ **–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞** `project_users`!
- ‚úÖ `project_users` = **whitelist** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–µ–∫—Ç—É
- ‚úÖ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ `project_users` –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ ‚Üí –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

**–†–µ—à–µ–Ω–∏–µ:**

```sql
CREATE TABLE project_users (
  id UUID PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),  -- –ö—Ç–æ –¥–æ–±–∞–≤–∏–ª (–∞–¥–º–∏–Ω)
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'banned')),
  UNIQUE(project_id, user_id)  -- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
);
```

**–õ–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞:**

```typescript
// –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞
async function checkProjectAccess(
  projectId: string,
  userId: string
): Promise<boolean> {
  const { data } = await supabase
    .from("project_users")
    .select("id, status")
    .eq("project_id", projectId)
    .eq("user_id", userId)
    .eq("status", "active")
    .single();

  return !!data; // –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–ø–∏—Å—å
}
```

**–í—ã–≤–æ–¥:** `project_users` **–ù–£–ñ–ù–ê** –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è.

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è project_users

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

**`project_users` - —ç—Ç–æ whitelist –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞**

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

1. ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞
2. ‚úÖ –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Supabase, –Ω–æ –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ `project_users` –Ω–µ –ø–æ–ª—É—á–∏—Ç –¥–æ—Å—Ç—É–ø
4. ‚ùå –ù–ï –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π (–ø—Ä–æ—Ñ–∏–ª—å –≤ `profiles`)
5. ‚ùå –ù–ï –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π (–ø–∞—Ä–æ–ª–∏ –≤ `auth.users`)
6. ‚ùå –ù–ï –¥–ª—è —Å–≤—è–∑–µ–π —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º `created_by` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–≤—è–∑–µ–π)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE TABLE project_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–∞
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'banned')),

  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),  -- –ö—Ç–æ –¥–æ–±–∞–≤–∏–ª (–∞–¥–º–∏–Ω)
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  UNIQUE(project_id, user_id)  -- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_project_users_project_id ON project_users(project_id);
CREATE INDEX idx_project_users_user_id ON project_users(user_id);
CREATE INDEX idx_project_users_status ON project_users(status) WHERE status = 'active';
```

### –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```mermaid
sequenceDiagram
    participant User
    participant App
    participant SupabaseAuth
    participant ProjectUsers

    User->>App: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
    App->>SupabaseAuth: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    SupabaseAuth-->>App: ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (user_id)

    App->>ProjectUsers: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞<br/>SELECT * FROM project_users<br/>WHERE project_id=? AND user_id=? AND status='active'

    alt –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ project_users
        ProjectUsers-->>App: ‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞
        App-->>User: ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
    else –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤ project_users
        ProjectUsers-->>App: ‚ùå –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        App-->>User: ‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
    end
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

| –°—Ü–µ–Ω–∞—Ä–∏–π                        | –ù—É–∂–Ω–∞ project_users? | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞                                    |
| ------------------------------- | -------------------- | ----------------------------------------------- |
| –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ —Å–≤—è–∑–∏ | ‚ùå –ù–µ—Ç               | –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–≤—è–∑–µ–π (user_company, –∏ —Ç.–¥.) |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã  | ‚ùå –ù–µ—Ç               | `created_by` + RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (Owner\|Admin)      |
| –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏      | ‚úÖ **–î–∞**            | `project_users` –∫–∞–∫ whitelist                   |
| –†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤     | ‚ùå –ù–µ—Ç               | –û–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å –≤ `profiles`                       |
| –†–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤      | ‚ùå –ù–µ—Ç               | –û–¥–∏–Ω –ø–∞—Ä–æ–ª—å –≤ `auth.users`                      |

---

## üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–∏–º–µ–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `project_users`

**–†–µ—à–µ–Ω–∏–µ:**

```typescript
// –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
async function signUp(projectId: string, email: string, password: string) {
  // 1. –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase Auth
  const {
    data: { user },
  } = await supabase.auth.signUp({
    email,
    password,
  });

  // 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ project_users
  await supabase.from("project_users").insert({
    project_id: projectId,
    user_id: user.id,
    status: "active",
  });

  return user;
}
```

**–í—ã–≤–æ–¥:** `project_users` –Ω—É–∂–Ω–∞, –Ω–æ –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ì–∏–±—Ä–∏–¥–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:
  - –° —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ `project_users`)
  - –ë–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ `project_users`)

**–†–µ—à–µ–Ω–∏–µ:**

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ projects
ALTER TABLE projects
ADD COLUMN allow_public_registration BOOLEAN DEFAULT false;
```

```typescript
async function signUp(projectId: string, email: string, password: string) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–æ–µ–∫—Ç–∞
  const { data: project } = await supabase
    .from("projects")
    .select("allow_public_registration")
    .eq("id", projectId)
    .single();

  if (!project?.allow_public_registration) {
    throw new Error("Registration is not allowed for this project");
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ project_users
  // ...
}
```

**–í—ã–≤–æ–¥:** `project_users` –Ω—É–∂–Ω–∞, –ª–æ–≥–∏–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞.

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ project_users

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```sql
project_users (
  id UUID PRIMARY KEY,
  project_id UUID ‚Üí projects,
  user_id UUID ‚Üí auth.users,
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ,
  created_by UUID ‚Üí auth.users,  -- –ö—Ç–æ –¥–æ–±–∞–≤–∏–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  UNIQUE(project_id, user_id)
)
```

**–ù–ï –Ω—É–∂–Ω—ã:**

- ‚ùå `password_hash` (–ø–∞—Ä–æ–ª–∏ –≤ `auth.users`)
- ‚ùå `profile` (–ø—Ä–æ—Ñ–∏–ª—å –≤ `profiles`)
- ‚ùå `oauth_providers` (OAuth —á–µ—Ä–µ–∑ Supabase Auth)

### 2. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

**`project_users` = whitelist –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞**

- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- ‚úÖ –ê–¥–º–∏–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

```typescript
// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞
async function requireProjectAccess(
  projectId: string,
  userId: string
): Promise<void> {
  const { data } = await supabase
    .from("project_users")
    .select("id")
    .eq("project_id", projectId)
    .eq("user_id", userId)
    .eq("status", "active")
    .single();

  if (!data) {
    throw new Error("Access denied: User is not authorized for this project");
  }
}
```

### 4. –°–≤—è–∑–∏ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏

**–ò—Å–ø–æ–ª—å–∑—É–µ–º `created_by` ‚Üí `auth.users.id` (–ù–ï `project_users.id`)**

**–ü–æ—á–µ–º—É:**

- `created_by` –¥–æ–ª–∂–µ–Ω —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`auth.users.id`)
- `project_users` - —ç—Ç–æ —Ç–æ–ª—å–∫–æ whitelist, –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `auth.uid()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞

---

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è

1. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é?** `project_users` = whitelist –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
2. **–°–≤—è–∑–∏ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏:** –ò—Å–ø–æ–ª—å–∑—É–µ–º `created_by` ‚Üí `auth.users.id` –∏–ª–∏ `project_users.id`?
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ:** –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ `project_users`?
4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:** –ù—É–∂–Ω–∞ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `allow_public_registration` –≤ `projects`?

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** –ù–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–∏
