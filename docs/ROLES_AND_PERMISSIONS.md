# –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-30  
**–í–µ—Ä—Å–∏—è:** 2.0 (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–†–æ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ](#—Ä–æ–ª–∏-–≤-—Å–∏—Å—Ç–µ–º–µ)
3. [API —Ö—É–∫–∞ useRole](#api-—Ö—É–∫–∞-userole)
4. [–¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞](#—Ç–∞–±–ª–∏—Ü–∞-–ø—Ä–∞–≤-–¥–æ—Å—Ç—É–ø–∞)
5. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
6. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–º –ø—Ä–∏–Ω—Ü–∏–ø–µ:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏** ‚Üí –æ–¥–∏–Ω RPC –∑–∞–ø—Ä–æ—Å –∫ –ë–î
2. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ UI** ‚Üí –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
3. **–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –º—É—Ç–∞—Ü–∏–∏** ‚Üí –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º/–∑–∞–ø—Ä–µ—â–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏

### –ï–¥–∏–Ω—ã–π —Ö—É–∫ `useRole`

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ–¥–∏–Ω —Ö—É–∫ `useRole(projectId?)`:

```typescript
import { useRole } from "@/hooks/use-role";

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–æ–ª—å (–±–µ–∑ projectId)
const { isSuperAdmin, isAdmin, displayRole } = useRole();

// –†–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ (—Å projectId)
const { role, isReadOnly, canEdit } = useRole(projectId);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –û–¥–∏–Ω RPC –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö
- ‚úÖ –ï–¥–∏–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ React Query
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –†–æ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ

### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏

| –†–æ–ª—å         | –û–ø–∏—Å–∞–Ω–∏–µ              | –î–æ—Å—Ç—É–ø                                        |
| ------------ | --------------------- | --------------------------------------------- |
| `superAdmin` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω | –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏  |
| `user`       | –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  | –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É (—Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /welcome) |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –õ—é–±–æ–π –∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞ (projectSuperAdmin, projectAdmin) –∏–º–µ–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ä–æ–ª—å `user`, –Ω–æ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É —á–µ—Ä–µ–∑ middleware –ø—Ä–æ–≤–µ—Ä–∫—É.

### –†–æ–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ

| –†–æ–ª—å                | –û–ø–∏—Å–∞–Ω–∏–µ              | –ü—Ä–∞–≤–∞                                                       |
| ------------------- | --------------------- | ----------------------------------------------------------- |
| `superAdmin`        | –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω | –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º                              |
| `projectSuperAdmin` | –°—É–ø–µ—Ä–∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞    | –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ |
| `projectAdmin`      | –ê–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞         | –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º             |
| `null`              | –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞           | –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É                                       |

---

## API —Ö—É–∫–∞ useRole

### –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```typescript
function useRole(projectId?: string | undefined): RoleData & {
  isLoading: boolean;
  error: Error | null;
};
```

### –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ

```typescript
interface RoleData {
  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–æ–ª—å
  globalRole: "superAdmin" | "user";

  // –†–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ (–µ—Å–ª–∏ projectId –ø–µ—Ä–µ–¥–∞–Ω)
  projectRole: "superAdmin" | "projectSuperAdmin" | "projectAdmin" | null;

  // –§–ª–∞–≥–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  isSuperAdmin: boolean;
  isProjectSuperAdmin: boolean;
  isProjectAdmin: boolean;
  isReadOnly: boolean; // true –¥–ª—è projectAdmin
  canEdit: boolean; // true –¥–ª—è superAdmin –∏ projectSuperAdmin
  isAdmin: boolean; // true –µ—Å–ª–∏ –ª—é–±–∞—è —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞

  // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  displayRole: string; // 'superAdmin' | 'projectSuperAdmin' | 'projectAdmin' | 'user'
}
```

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ä–æ–ª–∏

```typescript
const { isSuperAdmin, displayRole } = useRole();

if (isSuperAdmin) {
  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
}
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ

```typescript
const { isReadOnly, canEdit } = useRole(projectId);

// –ü–µ—Ä–µ–¥–∞—Ç—å readOnly –≤ —Ñ–æ—Ä–º—É
<UniversalEntityFormNew readOnly={isReadOnly} />;

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
if (canEdit) {
  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
}
```

#### 3. –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤

```typescript
const { isSuperAdmin, isProjectSuperAdmin, isReadOnly, canEdit } =
  useRole(projectId);

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ - —Ç–æ–ª—å–∫–æ superAdmin
const canCreateProject = isSuperAdmin;

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ - superAdmin –∏–ª–∏ projectSuperAdmin
const canEditProject = canEdit;

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏ - superAdmin –∏–ª–∏ projectSuperAdmin
const canManageAdmins = isSuperAdmin || isProjectSuperAdmin;
```

---

## –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ (—á–µ—Ä–µ–∑ JSON –∫–æ–Ω—Ñ–∏–≥–∏)

#### 1. Projects

| –î–µ–π—Å—Ç–≤–∏–µ                   | superAdmin | projectSuperAdmin | projectAdmin | user |
| -------------------------- | ---------- | ----------------- | ------------ | ---- |
| **–°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤**        | ‚úÖ –í—Å–µ     | ‚úÖ –°–≤–æ–∏           | ‚úÖ –°–≤–æ–∏      | ‚ùå   |
| **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞**       | ‚úÖ         | ‚ùå                | ‚ùå           | ‚ùå   |
| **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞** | ‚úÖ –õ—é–±–æ–π   | ‚úÖ –°–≤–æ–π           | ‚ùå           | ‚ùå   |
| **–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞**       | ‚úÖ         | ‚ùå                | ‚ùå           | ‚ùå   |

#### 2. Entity Definitions

| –î–µ–π—Å—Ç–≤–∏–µ           | superAdmin | projectSuperAdmin | projectAdmin   | user |
| ------------------ | ---------- | ----------------- | -------------- | ---- |
| **–°–ø–∏—Å–æ–∫**         | ‚úÖ         | ‚úÖ                | ‚úÖ (read-only) | ‚ùå   |
| **–°–æ–∑–¥–∞–Ω–∏–µ**       | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |
| **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |
| **–£–¥–∞–ª–µ–Ω–∏–µ**       | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |

#### 3. Environments

| –î–µ–π—Å—Ç–≤–∏–µ           | superAdmin | projectSuperAdmin | projectAdmin   | user |
| ------------------ | ---------- | ----------------- | -------------- | ---- |
| **–°–ø–∏—Å–æ–∫**         | ‚úÖ         | ‚úÖ                | ‚úÖ (read-only) | ‚ùå   |
| **–°–æ–∑–¥–∞–Ω–∏–µ**       | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |
| **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |
| **–£–¥–∞–ª–µ–Ω–∏–µ**       | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |

#### 4. Fields

| –î–µ–π—Å—Ç–≤–∏–µ           | superAdmin | projectSuperAdmin | projectAdmin   | user |
| ------------------ | ---------- | ----------------- | -------------- | ---- |
| **–°–ø–∏—Å–æ–∫**         | ‚úÖ         | ‚úÖ                | ‚úÖ (read-only) | ‚ùå   |
| **–°–æ–∑–¥–∞–Ω–∏–µ**       | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |
| **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |
| **–£–¥–∞–ª–µ–Ω–∏–µ**       | ‚úÖ         | ‚úÖ                | ‚ùå             | ‚ùå   |

#### 5. Admins

| –î–µ–π—Å—Ç–≤–∏–µ           | superAdmin     | projectSuperAdmin        | projectAdmin | user |
| ------------------ | -------------- | ------------------------ | ------------ | ---- |
| **–°–ø–∏—Å–æ–∫**         | ‚úÖ –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã | ‚úÖ –°–≤–æ–π –ø—Ä–æ–µ–∫—Ç           | ‚ùå           | ‚ùå   |
| **–°–æ–∑–¥–∞–Ω–∏–µ**       | ‚úÖ –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã | ‚úÖ –°–≤–æ–π –ø—Ä–æ–µ–∫—Ç           | ‚ùå           | ‚ùå   |
| **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚úÖ –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã | ‚úÖ –°–≤–æ–π –ø—Ä–æ–µ–∫—Ç (–Ω–µ —Å–µ–±—è) | ‚ùå           | ‚ùå   |
| **–£–¥–∞–ª–µ–Ω–∏–µ**       | ‚úÖ –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã | ‚úÖ –°–≤–æ–π –ø—Ä–æ–µ–∫—Ç (–Ω–µ —Å–µ–±—è) | ‚ùå           | ‚ùå   |

### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (Entity Instances)

**–ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏!** –í—Å–µ —Ä–æ–ª–∏ –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–æ–∑–¥–∞–Ω–∏—é/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é/—É–¥–∞–ª–µ–Ω–∏—é entity instances.

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
import { useRole } from "@/hooks/use-role";

function EntityDefinitionForm({ projectId, entityId }) {
  const { isReadOnly } = useRole(projectId);

  return (
    <UniversalEntityFormNew
      projectId={projectId}
      instanceId={entityId}
      readOnly={isReadOnly}
    />
  );
}
```

### –ü—Ä–∏–º–µ—Ä 2: –°–ø–∏—Å–æ–∫ —Å —É—Å–ª–æ–≤–Ω—ã–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º

```typescript
import { useRole } from "@/hooks/use-role";

function ProjectsList() {
  const { isSuperAdmin } = useRole();

  return (
    <div>
      {isSuperAdmin && <Button onClick={handleCreate}>Create Project</Button>}
      <ProjectsListClient />
    </div>
  );
}
```

### –ü—Ä–∏–º–µ—Ä 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

```typescript
import { useRole } from "@/hooks/use-role";

function ProjectSettings({ projectId }) {
  const { canEdit, isSuperAdmin } = useRole(projectId);

  // superAdmin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–π –ø—Ä–æ–µ–∫—Ç
  // projectSuperAdmin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç
  const canEditProject = isSuperAdmin || canEdit;

  return <ProjectFormNew projectId={projectId} readOnly={!canEditProject} />;
}
```

### –ü—Ä–∏–º–µ—Ä 4: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏

```typescript
import { useRole } from "@/hooks/use-role";

function AdminsPage({ projectId }) {
  const { isSuperAdmin, isProjectSuperAdmin } = useRole(projectId);

  const canManageAdmins = isSuperAdmin || isProjectSuperAdmin;

  if (!canManageAdmins) {
    return <div>Access denied</div>;
  }

  return <AdminsList projectId={projectId} />;
}
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

#### –¢–∞–±–ª–∏—Ü–∞ `admin_roles`

–†–æ–ª–∏ –∞–¥–º–∏–Ω–æ–≤:

- `superAdmin` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω
- `projectSuperAdmin` - —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞
- `projectAdmin` - –∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞

#### –¢–∞–±–ª–∏—Ü–∞ `project_admins`

–í—Å–µ –∞–¥–º–∏–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ:

- `superAdmin` ‚Üí `project_id = NULL` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- `projectSuperAdmin` / `projectAdmin` ‚Üí `project_id = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç`

### SQL —Ñ—É–Ω–∫—Ü–∏–∏

#### `is_super_admin(user_uuid UUID) ‚Üí BOOLEAN`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–ª–æ–±–∞–ª—å–Ω—ã–º superAdmin.

#### `is_any_admin(user_uuid UUID) ‚Üí BOOLEAN`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª—é–±—ã–º –∞–¥–º–∏–Ω–æ–º (–¥–ª—è middleware).

#### `get_user_project_role(p_project_id UUID, p_user_id UUID) ‚Üí TEXT`

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

- `'superAdmin'` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π superAdmin
- `'projectSuperAdmin'` - —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞
- `'projectAdmin'` - –∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞
- `NULL` - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞

### RLS –ø–æ–ª–∏—Ç–∏–∫–∏

–í—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏ `is_super_admin()` –∏ `get_user_project_role()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤.

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ (–≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è):

1. **`20250130000000_create_unified_admins_structure.sql`** - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∞–¥–º–∏–Ω–æ–≤
2. **`20250130000001_fix_project_admins_rls_recursion.sql`** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫—É—Ä—Å–∏–∏ –≤ RLS
3. **`20250130000005_simplify_roles_functions.sql`** - —É–ø—Ä–æ—â–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Ä–æ–ª–µ–π
4. **`20250130000006_final_roles_migration.sql`** - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è, –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏

**–í–∞–∂–Ω–æ:** –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

---

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä—ã—Ö —Ö—É–∫–æ–≤

### –ë—ã–ª–æ (—É—Å—Ç–∞—Ä–µ–≤—à–µ–µ)

```typescript
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–æ–ª—å
const { role, isSuperAdmin } = useUserRole();

// –†–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
const { role, isReadOnly } = useProjectRole(projectId);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
const { canEdit } = useCanEditProject(projectId);
```

### –°—Ç–∞–ª–æ (–Ω–æ–≤–æ–µ)

```typescript
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–æ–ª—å
const { globalRole, isSuperAdmin } = useRole();

// –†–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
const { projectRole, isReadOnly } = useRole(projectId);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
const { canEdit } = useRole(projectId);
```

**–°—Ç–∞—Ä—ã–µ —Ö—É–∫–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ `@deprecated`**, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–û–¥–∏–Ω RPC –∑–∞–ø—Ä–æ—Å** –≤–º–µ—Å—Ç–æ 2-3 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ React Query** (5 –º–∏–Ω—É—Ç) –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- **Cookie –∫—ç—à –≤ middleware** (5 –º–∏–Ω—É—Ç) –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ `hasAccess`
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–µ–π –ø—Ä–æ–µ–∫—Ç–æ–≤**: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ `project_admins` –≤–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

#### Middleware (—Å–µ—Ä–≤–µ—Ä)

- –ö—ç—à–∏—Ä—É–µ—Ç `hasAccess` (boolean) –≤ httpOnly –∫—É–∫–µ `x-user-access-cache`
- TTL: 5 –º–∏–Ω—É—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É

#### Server Components

- –ü–æ–ª—É—á–∞—é—Ç —Ä–æ–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î (–±–µ–∑ –∫—ç—à–∞ –∫—É–∫)
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ `project_admins` –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π

#### Client Components

- React Query –∫—ç—à–∏—Ä—É–µ—Ç —Ä–æ–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ (5 –º–∏–Ω—É—Ç)
- –•—É–∫ `useRole(projectId?)` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç React Query –∫—ç—à

### –£–ø—Ä–æ—â–µ–Ω–∏–µ

- **3 —Ö—É–∫–∞ ‚Üí 1 —Ö—É–∫** (`useRole`)
- **10+ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí 1 –¥–æ–∫—É–º–µ–Ω—Ç** (—ç—Ç–æ—Ç)
- **–ï–¥–∏–Ω—ã–π API** –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ä–æ–ª–µ–π

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
// –í —Ç–µ—Å—Ç–∞—Ö –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å useRole
jest.mock("@/hooks/use-role", () => ({
  useRole: jest.fn(() => ({
    isSuperAdmin: true,
    isReadOnly: false,
    canEdit: true,
    isLoading: false,
    error: null,
  })),
}));
```

### Unit —Ç–µ—Å—Ç—ã

```typescript
describe("useRole", () => {
  it("should return superAdmin role", async () => {
    // –¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ —Ö—É–∫–∞
  });
});
```

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-30  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-30

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [ROLES_DEBUG_GUIDE.md](./ROLES_DEBUG_GUIDE.md) - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–ª–∞–¥–∫–µ —Å–∏—Å—Ç–µ–º—ã —Ä–æ–ª–µ–π
- [MIGRATION_SUMMARY.md](./MIGRATION_SUMMARY.md) - –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
