# Безопасность сброса пароля в Supabase

## Как Supabase проверяет, что можно доверять обновлению пароля

### 1. Токен сброса пароля

Когда пользователь запрашивает сброс пароля:

- Supabase генерирует **уникальный криптографический токен**
- Токен подписывается **секретным ключом Supabase** (JWT Secret)
- Токен имеет **ограниченный срок действия** (обычно 1 час)
- Токен отправляется пользователю **только на его email**

### 2. Валидация токена на сервере Supabase

Когда пользователь переходит по ссылке из письма:

```
https://your-project.supabase.co/auth/v1/verify?token=...&type=recovery
```

**Что происходит:**

1. Supabase **проверяет токен на своем сервере**:

   - Проверяет подпись токена (JWT signature)
   - Проверяет срок действия токена
   - Проверяет, что токен не был использован ранее
   - Проверяет, что email соответствует токену

2. Если токен валидный → Supabase создает **специальную сессию для recovery**

   - Сессия содержит JWT токен (access_token)
   - Токен подписан секретным ключом Supabase
   - Токен содержит информацию о пользователе и типе сессии (recovery)
   - Токен имеет ограниченные права (только обновление пароля)

3. Supabase редиректит на наш URL с токеном в hash:
   ```
   http://localhost:3000/auth/reset-password#access_token=JWT_TOKEN&type=recovery
   ```

### 3. Установка сессии в клиенте

Когда Supabase клиент обрабатывает токен из hash:

```typescript
const supabase = createBrowserSupabaseClient(...);
// Supabase автоматически извлекает access_token из hash
// И сохраняет его в cookies/localStorage как сессию
```

**Сессия содержит:**

- `access_token` - JWT токен, подписанный Supabase
- `refresh_token` - для обновления токена
- `user` - информация о пользователе
- Метаданные о типе сессии (recovery)

### 4. Проверка сессии при updateUser()

Когда вызывается `supabase.auth.updateUser({ password: newPassword })`:

**Supabase проверяет на сервере:**

1. **JWT токен валиден:**

   - Подпись токена проверяется секретным ключом
   - Токен не истек
   - Токен не был отозван

2. **Сессия имеет права на обновление пароля:**

   - Токен содержит флаг `type: recovery` или `recovery: true`
   - Пользователь аутентифицирован через recovery flow

3. **Пользователь существует:**
   - ID пользователя из токена существует в базе данных
   - Email соответствует токену

**Только после всех проверок** Supabase обновляет пароль в базе данных.

## Почему это безопасно?

### ✅ Защита от подделки токена

- Токен подписан секретным ключом Supabase (JWT Secret)
- Невозможно подделать токен без знания секретного ключа
- Секретный ключ хранится только на сервере Supabase

### ✅ Защита от перехвата

- Токен передается через **hash** (`#access_token=...`), а не через query параметры
- Hash **не отправляется на сервер** при обычных запросах
- Токен виден только в браузере пользователя

### ✅ Ограниченный срок действия

- Токен истекает через определенное время (обычно 1 час)
- После истечения токен не может быть использован

### ✅ Одноразовое использование

- После обновления пароля сессия recovery становится невалидной
- Невозможно использовать тот же токен повторно

### ✅ Проверка на сервере

- Все проверки происходят **на сервере Supabase**
- Клиент не может обойти проверки
- Даже если кто-то перехватит токен, он истечет через время

## Важно понимать

**Сессия = Доказательство валидации токена**

Когда у нас есть валидная сессия с типом `recovery`, это означает:

- ✅ Токен был проверен Supabase на своем сервере
- ✅ Токен валидный и не истек
- ✅ Пользователь действительно запросил сброс пароля
- ✅ Email соответствует токену

Поэтому `updateUser()` доверяет этой сессии - она уже прошла все проверки безопасности на сервере Supabase.

## Аналогия

Представьте, что токен - это **билет в кино**:

1. Вы покупаете билет (запрашиваете сброс пароля)
2. Билетер проверяет билет на входе (Supabase проверяет токен)
3. Вам выдают браслет (сессия с access_token)
4. С браслетом вы можете войти в зал (обновить пароль)
5. Без браслета вас не пустят (без сессии updateUser() не сработает)
