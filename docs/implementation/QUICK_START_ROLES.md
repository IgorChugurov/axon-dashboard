# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìã –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ!)

1. **`SUPABASE_MIGRATION.sql`** - –±–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
   - –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `profiles`
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç RLS

2. **`SUPABASE_ROLES_MIGRATION.sql`** - –º–∏–≥—Ä–∞—Ü–∏—è —Ä–æ–ª–µ–π
   - –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `admin_roles` –∏ `admins`
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç RLS –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

3. **`SUPABASE_PROJECTS_MIGRATION.sql`** - –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
   - –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `projects`
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç RLS (–∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏)

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

```bash
pnpm create-super-admin
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `igorchugurov@gmail.com` / `1234567!Igor`
- –ü—Ä–æ—Ñ–∏–ª—å –≤ `profiles`
- –ó–∞–ø–∏—Å—å –≤ `admins` —Å —Ä–æ–ª—å—é `superAdmin`

### –®–∞–≥ 3: –í–æ–π—Ç–∏ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3000`
2. –í–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ `/login`
3. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ `igorchugurov@gmail.com` / `1234567!Igor`
4. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º (—Ä–æ–ª—å `superAdmin`)

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏

### ‚ö†Ô∏è –í–∞–∂–Ω–æ: –†–æ–ª—å –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ cookies!

**–ü–æ—á–µ–º—É?**
- –†–æ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è (–∞–¥–º–∏–Ω–∞ –º–æ–≥—É—Ç —É–¥–∞–ª–∏—Ç—å)
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ cookies –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ (–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å)
- –†–æ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –ë–î –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏

### –§–ª–æ—É –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç
   ‚Üì
2. Supabase —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ httpOnly cookies
   ‚Üì
3. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:
   - getServerUser() –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
   - getUserRole() –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–æ–ª—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã admins
   - –†–æ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –æ–±—ä–µ–∫—Ç—É User
   ‚Üì
4. Middleware/API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –∏ –¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø
```

### –ö–æ–¥:

```typescript
// lib/supabase/auth.ts
export async function getServerUser(): Promise<User | null> {
  const user = transformSupabaseUser(supabaseUser);
  
  // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã admins
  if (user) {
    const role = await getUserRole(user.id!);
    user.role = role; // 'user' | 'admin' | 'superAdmin'
  }
  
  return user;
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö API

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:

```bash
curl -X POST http://localhost:3000/api/projects \
  -H "Content-Type: application/json" \
  -H "Cookie: <your-session-cookie>" \
  -d '{
    "name": "My First Project",
    "description": "Test project",
    "status": "active"
  }'
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤:

```bash
curl http://localhost:3000/api/projects \
  -H "Cookie: <your-session-cookie>"
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–ö–∞–∫ superAdmin:**
   - –í–∏–¥–∏—Ç–µ –í–°–ï –ø—Ä–æ–µ–∫—Ç—ã (–¥–∞–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏–º–∏)
   - –ú–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã
   - RLS –ø–æ–ª–∏—Ç–∏–∫–∞ "Admins can view all projects" –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

2. **–ö–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
   - –í–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ –°–í–û–ò –ø—Ä–æ–µ–∫—Ç—ã
   - –ú–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã
   - RLS –ø–æ–ª–∏—Ç–∏–∫–∞ "Users can view own projects" –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–æ–ª—å –≤ –ë–î:

```sql
-- –í Supabase SQL Editor
SELECT 
  u.email,
  ar.name as role
FROM auth.users u
LEFT JOIN admins a ON a.user_id = u.id
LEFT JOIN admin_roles ar ON ar.id = a.role_id
WHERE u.email = 'igorchugurov@gmail.com';
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: `superAdmin`

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–¥–µ:

–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞, –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
[Supabase Auth] User from Supabase: igorchugurov@gmail.com
[Roles] Role: superAdmin
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø:

- ‚úÖ –ú–æ–∂–µ—Ç–µ –ø–æ–ø–∞—Å—Ç—å –≤ –¥–∞—à–±–æ—Ä–¥ (–Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/welcome`)
- ‚úÖ –ú–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ API
- ‚úÖ –í–∏–¥–∏—Ç–µ –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ —Å–ø–∏—Å–∫–µ

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### User –æ–±—ä–µ–∫—Ç –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è:

```typescript
{
  id: "uuid-here",
  email: "igorchugurov@gmail.com",
  firstName: "Igor",
  lastName: "Chugurov",
  role: "superAdmin", // ‚Üê –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã admins
  createdAt: "2024-01-01T00:00:00Z",
  updatedAt: "2024-01-01T00:00:00Z"
}
```

### Cookies (—Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã):

```
sb-<project-ref>-auth-token: <jwt-token>
```

**–†–æ–ª—å –ù–ï –≤ cookies!** –û–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

---

## üéØ –ò—Ç–æ–≥

‚úÖ **–ü–æ—Ä—è–¥–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:**
1. SUPABASE_MIGRATION.sql
2. SUPABASE_ROLES_MIGRATION.sql  
3. SUPABASE_PROJECTS_MIGRATION.sql

‚úÖ **–†–æ–ª—å –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –ë–î:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ —á–µ—Ä–µ–∑ `getUserRole()`
- –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ cookies
- –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞

‚úÖ **–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞:**
- –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ `igorchugurov@gmail.com`
- –ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º
- –ú–æ–∂–µ—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –ø—Ä–æ–µ–∫—Ç–æ–≤

‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

