# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∞–¥–º–∏–Ω–æ–≤

## üìã –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç:**

```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase Dashboard ‚Üí SQL Editor
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('admin_roles', 'admins', 'project_admins');
```

**–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –ù–ï —Å—É—â–µ—Å—Ç–≤—É—é—Ç:**

1. **–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:** `docs/implementation/SUPABASE_ROLES_MIGRATION.sql`

   - –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `admin_roles` –∏ `admins`
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ RLS

2. **–ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:** `supabase/migrations/20250130000002_create_project_admins.sql`
   - –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `project_admins`
   - –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–µ–∫—Ç–Ω—ã–µ —Ä–æ–ª–∏ –≤ `admin_roles`

---

### –®–∞–≥ 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–§–∞–π–ª:** `supabase/migrations/20250130000003_unified_admins_structure.sql`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è:**

1. ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç —Ä–æ–ª—å `superAdmin` –≤ `admin_roles` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
2. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç `project_admins`: –¥–µ–ª–∞–µ—Ç `project_id` NULLABLE
3. ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç `superAdmin` –∏–∑ `admins` –≤ `project_admins` —Å `project_id = NULL`
4. ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (superAdmin –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å `project_id = NULL`)
5. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
6. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏
7. ‚ö†Ô∏è **–ù–ï —É–¥–∞–ª—è–µ—Ç** —Ç–∞–±–ª–∏—Ü—É `admins` (–Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:**

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
# 2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª: supabase/migrations/20250130000003_unified_admins_structure.sql
# 3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å SQL –∫–æ–¥
# 4. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
# 5. –ù–∞–∂–º–∏—Ç–µ "Run" –∏–ª–∏ "Execute"

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase CLI
cd /Users/igorchugurov/Documents/GitHub/OUR-pack/axon-dashboard
supabase db push
```

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ superAdmin –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω
SELECT
  pa.user_id,
  ar.name as role_name,
  pa.project_id,
  u.email
FROM project_admins pa
JOIN admin_roles ar ON pa.role_id = ar.id
JOIN auth.users u ON pa.user_id = u.id
WHERE ar.name = 'superAdmin';

-- –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–ø–∏—Å–∏ —Å project_id = NULL

-- 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ '–≤–∞—à-user-id' –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π UUID)
SELECT public.is_super_admin('–≤–∞—à-user-id'); -- –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å true/false
SELECT public.is_any_admin('–≤–∞—à-user-id'); -- –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å true/false
SELECT public.get_user_role('–≤–∞—à-user-id'); -- –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 'superAdmin' –∏–ª–∏ 'admin' –∏–ª–∏ 'user'

-- 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
SELECT public.get_accessible_project_ids('–≤–∞—à-user-id'); -- –º–∞—Å—Å–∏–≤ UUID –ø—Ä–æ–µ–∫—Ç–æ–≤
```

---

### –®–∞–≥ 4: –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `admins` (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)

**‚ö†Ô∏è –í–ê–ñ–ù–û: –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –≤—Å–µ superAdmin –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã!**

```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase Dashboard ‚Üí SQL Editor
DROP TABLE IF EXISTS public.admins CASCADE;
```

---

## üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –ë–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç)

**–§–∞–π–ª:** `docs/implementation/SUPABASE_ROLES_MIGRATION.sql`

**–ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç:**

- –¢–∞–±–ª–∏—Ü–∞ `admin_roles` (—Ä–æ–ª–∏: admin, superAdmin)
- –¢–∞–±–ª–∏—Ü–∞ `admins` (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∞–¥–º–∏–Ω—ã)
- –§—É–Ω–∫—Ü–∏–∏: `is_super_admin()`, `is_admin()`, `get_user_role()`
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `admins`

**–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å:** –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã `admin_roles` –∏ `admins` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç

---

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤

**–§–∞–π–ª:** `supabase/migrations/20250130000002_create_project_admins.sql`

**–ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç:**

- –î–æ–±–∞–≤–ª—è–µ—Ç —Ä–æ–ª–∏ –≤ `admin_roles`: `projectAdmin`, `projectSuperAdmin`
- –¢–∞–±–ª–∏—Ü–∞ `project_admins` (–∞–¥–º–∏–Ω—ã –ø—Ä–æ–µ–∫—Ç–æ–≤)
- –§—É–Ω–∫—Ü–∏–∏: `is_project_super_admin()`, `is_project_admin()`, `get_user_project_role()`
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `project_admins`

**–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å:** –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ `project_admins` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

---

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ì–õ–ê–í–ù–ê–Ø)

**–§–∞–π–ª:** `supabase/migrations/20250130000003_unified_admins_structure.sql`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

- –û–±–Ω–æ–≤–ª—è–µ—Ç `project_admins` (–¥–µ–ª–∞–µ—Ç `project_id` NULLABLE)
- –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç `superAdmin` –∏–∑ `admins` –≤ `project_admins`
- –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
- –û–±–Ω–æ–≤–ª—è–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏

**–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å:** –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π 1 –∏ 2 (–∏–ª–∏ –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã)

---

## üîÑ –°—Ö–µ–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚îú‚îÄ –ù–ï–¢ —Ç–∞–±–ª–∏—Ü admin_roles, admins
               ‚îÇ  ‚îî‚îÄ‚Üí –í—ã–ø–æ–ª–Ω–∏—Ç—å: SUPABASE_ROLES_MIGRATION.sql
               ‚îÇ
               ‚îú‚îÄ –ù–ï–¢ —Ç–∞–±–ª–∏—Ü—ã project_admins
               ‚îÇ  ‚îî‚îÄ‚Üí –í—ã–ø–æ–ª–Ω–∏—Ç—å: 20250130000002_create_project_admins.sql
               ‚îÇ
               ‚îî‚îÄ –í–°–ï —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                  ‚îî‚îÄ‚Üí –í—ã–ø–æ–ª–Ω–∏—Ç—å: 20250130000003_unified_admins_structure.sql
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã `admin_roles` –∏ `admins` —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- [ ] –ï—Å–ª–∏ –Ω–µ—Ç - –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `SUPABASE_ROLES_MIGRATION.sql`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `project_admins` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [ ] –ï—Å–ª–∏ –Ω–µ—Ç - –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `20250130000002_create_project_admins.sql`
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `20250130000003_unified_admins_structure.sql`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ superAdmin –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ `project_admins` —Å `project_id = NULL`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏: `is_super_admin()`, `is_any_admin()`, `get_user_role()`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_accessible_project_ids()`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∞)
- [ ] –£–¥–∞–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `admins` (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –û—à–∏–±–∫–∞ "table does not exist"

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –±–∞–∑–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (`SUPABASE_ROLES_MIGRATION.sql` –∏ `20250130000002_create_project_admins.sql`)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `project_id` –Ω–∞ NULLABLE

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `project_admins` –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ä—É—à–∞—é—Ç UNIQUE constraint.

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ superAdmin

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `admins` –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å —Ä–æ–ª—å—é `superAdmin`:

```sql
SELECT a.*, ar.name
FROM admins a
JOIN admin_roles ar ON a.role_id = ar.id
WHERE ar.name = 'superAdmin';
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –§—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard ‚Üí Logs.

---

## üìù –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–ï—Å–ª–∏ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ `supabase/migrations/20250130000003_unified_admins_structure.sql`
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å SQL –∫–æ–¥
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ Supabase Dashboard ‚Üí SQL Editor
4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å–º. –®–∞–≥ 3)
6. –£–¥–∞–ª–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É `admins` (—Å–º. –®–∞–≥ 4)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
