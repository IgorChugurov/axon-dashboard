# –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã Middleware –∏ getServerUser

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Middleware

### Middleware –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

**–î–∞, middleware –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–µ**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ø–∞–¥–∞–µ—Ç –ø–æ–¥ `matcher` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Middleware:

1. **–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é Supabase** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤)
2. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é** (–µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤)
4. **–†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç** –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### ‚ö†Ô∏è –í–∞–∂–Ω–æ: Middleware –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç getServerUser!

**–ü–æ—á–µ–º—É?**

- `getServerUser()` –¥–µ–ª–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏
- –≠—Ç–æ –∑–∞–º–µ–¥–ª–∏—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- –í middleware –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Middleware:

```typescript
// middleware.ts
const {
  data: { user },
} = await supabase.auth.getUser();

// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ: –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
if (!user) {
  // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
}

// –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –∑–¥–µ—Å—å!
// –†–æ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ layout.tsx –∏–ª–∏ API routes
```

---

## üìç –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è getServerUser?

### 1. –í `app/layout.tsx` (Server Component)

```typescript
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const user = await getServerUser(); // ‚Üê –ó–¥–µ—Å—å –ø–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å
```

**–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**

- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Server Components)
- –ù–ï –ø—Ä–∏ –∫–∞–∂–¥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ)

### 2. –í API Routes

```typescript
// app/api/projects/route.ts
export async function GET() {
  const user = await getServerUser(); // ‚Üê –ó–¥–µ—Å—å –ø–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å
  if (!user)
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  // ...
}
```

**–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**

- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ API
- –ù–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö API routes

### 3. –í Server Actions

```typescript
// app/actions.ts
"use server";
export async function someAction() {
  const user = await getServerUser(); // ‚Üê –ó–¥–µ—Å—å –ø–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å
  // ...
}
```

---

## üéØ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞—Ç—å —Ä–æ–ª—å?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª—É—á–∞—Ç—å —Ä–æ–ª—å –≤–µ–∑–¥–µ (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥)

**–ü–ª—é—Å—ã:**

- –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ä–æ–ª—å
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ú–∏–Ω—É—Å—ã:**

- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ/API –∑–∞–ø—Ä–æ—Å–µ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏

```typescript
// lib/auth/roles.ts
const roleCache = new Map<string, { role: UserRole; timestamp: number }>();

export async function getUserRoleCached(userId: string): Promise<UserRole> {
  const cached = roleCache.get(userId);
  if (cached && Date.now() - cached.timestamp < 5 * 60 * 1000) {
    return cached.role; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à
  }

  const role = await getUserRole(userId); // –ó–∞–ø—Ä–æ—Å –∫ –ë–î
  roleCache.set(userId, { role, timestamp: Date.now() });
  return role;
}
```

**–ü–ª—é—Å—ã:**

- –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ë—ã—Å—Ç—Ä–µ–µ

**–ú–∏–Ω—É—Å—ã:**

- –ù—É–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏
- –†–æ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ 5 –º–∏–Ω—É—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–æ–ª—É—á–∞—Ç—å —Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ

```typescript
// –í middleware - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// –í layout - –ø–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
// –í API - –ø–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö endpoints
```

---

## üìä –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

### –ó–∞–ø—Ä–æ—Å –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:

```
1. HTTP –∑–∞–ø—Ä–æ—Å ‚Üí /dashboard
   ‚Üì
2. Middleware (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
   - updateSession() - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
   - supabase.auth.getUser() - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
   - –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
   - –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥–∞–ª—å—à–µ
   ‚Üì
3. Layout.tsx (Server Component)
   - getServerUser() - –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + —Ä–æ–ª—å
   - –ï—Å–ª–∏ —Ä–æ–ª—å = 'user' ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /welcome
   - –ï—Å–ª–∏ —Ä–æ–ª—å = 'admin'/'superAdmin' ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—à–±–æ—Ä–¥
   ‚Üì
4. Page Component —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è
```

### –ó–∞–ø—Ä–æ—Å –∫ API:

```
1. HTTP –∑–∞–ø—Ä–æ—Å ‚Üí /api/projects
   ‚Üì
2. Middleware (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
   - –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥–∞–ª—å—à–µ
   ‚Üì
3. API Route Handler
   - getServerUser() - –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + —Ä–æ–ª—å
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î (RLS –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   ‚Üì
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

---

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è getServerUser?

**–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å Server Components:**

- 1 —Ä–∞–∑ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≤ layout.tsx)
- –ù–ï –ø—Ä–∏ –∫–∞–∂–¥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–µ

**–ù–∞ API –∑–∞–ø—Ä–æ—Å–µ:**

- 1 —Ä–∞–∑ –≤ API route handler
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ API

**–í Middleware:**

- –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è!
- –¢–æ–ª—å–∫–æ `supabase.auth.getUser()` (–±—ã—Å—Ç—Ä–æ, –∏–∑ —Ç–æ–∫–µ–Ω–∞)

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (–µ—Å–ª–∏ —Ä–æ–ª—å —Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è)
2. **–ü–æ–ª—É—á–∞—Ç—å —Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ** (–Ω–µ –≤ middleware)
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RLS** (–∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î, –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ –∫–æ–¥–µ)

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω)
- ‚ùå –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ layout/API)

### Layout/API –ø—Ä–æ–≤–µ—Ä—è—é—Ç:

- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- ‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### RLS (Row Level Security):

- ‚úÖ –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **Middleware** - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–±—ã—Å—Ç—Ä–æ)
2. **Layout/API** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ (–∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ)
3. **RLS** - –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (–≤—Å–µ–≥–¥–∞)

**–ò—Ç–æ–≥:** `getServerUser()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–µ, –∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–ª–∏ –≤ API routes. Middleware —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.
