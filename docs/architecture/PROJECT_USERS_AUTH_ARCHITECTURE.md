# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–µ–∫—Ç–æ–≤

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `auth.users` (Supabase Auth) - –æ–¥–∏–Ω email = –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `created_by` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `auth.users.id`
- –û–¥–∏–Ω –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- –û–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

**–ù–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. ‚úÖ **–†–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏** –¥–ª—è –æ–¥–Ω–æ–≥–æ email –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
2. ‚úÖ **–†–∞–∑–Ω—ã–µ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã** –¥–ª—è –æ–¥–Ω–æ–≥–æ email –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
3. ‚úÖ **–†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏** –¥–ª—è –æ–¥–Ω–æ–≥–æ email –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
4. ‚úÖ **–°–≤—è–∑–∏ —á–µ—Ä–µ–∑ `project_users.id`**, –∞ –Ω–µ `auth.users.id`

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Supabase Auth

**–ü—Ä–æ–±–ª–µ–º–∞:**

- Supabase Auth –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **email –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä**
- –ù–µ–ª—å–∑—è –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ email
- –ù–µ–ª—å–∑—è –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ email –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
- `auth.users` - –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º

---

## üèóÔ∏è –†–µ—à–µ–Ω–∏–µ: –ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤:**

1. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `auth.users` (Supabase Auth)
2. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤** ‚Üí –∏—Å–ø–æ–ª—å–∑—É—é—Ç `project_users` (–∫–∞—Å—Ç–æ–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨                         ‚îÇ
‚îÇ  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: auth.users (Supabase Auth)                ‚îÇ
‚îÇ  - superAdmin, projectSuperAdmin, projectAdmin        ‚îÇ
‚îÇ  - –û–¥–∏–Ω email = –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ü–†–û–ï–ö–¢–û–í                        ‚îÇ
‚îÇ  –ò—Å–ø–æ–ª—å–∑—É—é—Ç: project_users (–∫–∞—Å—Ç–æ–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)     ‚îÇ
‚îÇ  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π                             ‚îÇ
‚îÇ  - –û–¥–∏–Ω email –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö       ‚îÇ
‚îÇ    –ø—Ä–æ–µ–∫—Ç–∞—Ö                                             ‚îÇ
‚îÇ  - –†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 1. –¢–∞–±–ª–∏—Ü–∞ `project_users` (–æ—Å–Ω–æ–≤–Ω–∞—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)

```sql
CREATE TABLE IF NOT EXISTS public.project_users (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

  -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  email TEXT NOT NULL,
  password_hash TEXT NOT NULL,  -- bcrypt hash –ø–∞—Ä–æ–ª—è
  email_verified BOOLEAN DEFAULT false,

  -- OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
  oauth_providers JSONB DEFAULT '{}'::jsonb,
  -- –§–æ—Ä–º–∞—Ç: {"google": {"id": "...", "email": "..."}, "github": {...}}

  -- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
  profile JSONB DEFAULT '{}'::jsonb,
  -- –§–æ—Ä–º–∞—Ç: {"firstName": "...", "lastName": "...", "avatar": "...", ...}

  -- –°—Ç–∞—Ç—É—Å
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'banned')),

  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  metadata JSONB DEFAULT '{}'::jsonb,

  -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,

  -- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  UNIQUE(project_id, email)  -- –û–¥–∏–Ω email = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_project_users_project_id ON project_users(project_id);
CREATE INDEX IF NOT EXISTS idx_project_users_email ON project_users(email);
CREATE INDEX IF NOT EXISTS idx_project_users_project_email ON project_users(project_id, email);
CREATE INDEX IF NOT EXISTS idx_project_users_status ON project_users(status) WHERE status = 'active';

-- GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB
CREATE INDEX IF NOT EXISTS idx_project_users_oauth_providers_gin
  ON project_users USING GIN (oauth_providers);
CREATE INDEX IF NOT EXISTS idx_project_users_profile_gin
  ON project_users USING GIN (profile);
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `entity_instance`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**

- `created_by` —Ç–µ–ø–µ—Ä—å —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `project_users.id`, –∞ –Ω–µ `auth.users.id`

```sql
-- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
ALTER TABLE entity_instance
  DROP COLUMN IF EXISTS created_by;

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
ALTER TABLE entity_instance
  ADD COLUMN created_by UUID REFERENCES project_users(id) ON DELETE SET NULL;

-- –ò–Ω–¥–µ–∫—Å
CREATE INDEX IF NOT EXISTS idx_entity_instance_created_by
  ON entity_instance(created_by) WHERE created_by IS NOT NULL;

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
COMMENT ON COLUMN entity_instance.created_by IS
  'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ project_users, —Å–æ–∑–¥–∞–≤—à–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä';
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü

**–¢–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**

- `entity_file` - —Ñ–∞–π–ª—ã, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `entity_relation` - —Å–≤—è–∑–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –î—Ä—É–≥–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å `created_by`

**–ú–∏–≥—Ä–∞—Ü–∏—è:**

```sql
-- –î–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å created_by:
ALTER TABLE table_name
  DROP COLUMN IF EXISTS created_by;

ALTER TABLE table_name
  ADD COLUMN created_by UUID REFERENCES project_users(id) ON DELETE SET NULL;
```

---

## üîê –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –î–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**

- `auth.users` (Supabase Auth)
- `admins` / `project_admins`
- –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ `role-service.ts`

### –î–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–æ–≤ (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)

**–ö–∞—Å—Ç–æ–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `project_users`:**

#### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```typescript
// POST /api/public/[projectId]/auth/sign-up
async function signUp(
  projectId: string,
  data: {
    email: string;
    password: string;
    firstName?: string;
    lastName?: string;
    // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è
  }
) {
  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –≤ project_users –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
  const existing = await supabase
    .from("project_users")
    .select("id")
    .eq("project_id", projectId)
    .eq("email", data.email)
    .single();

  if (existing) {
    throw new Error("User with this email already exists in this project");
  }

  // 2. –•–µ—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å (bcrypt)
  const passwordHash = await bcrypt.hash(data.password, 10);

  // 3. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ project_users
  const { data: user, error } = await supabase
    .from("project_users")
    .insert({
      project_id: projectId,
      email: data.email,
      password_hash: passwordHash,
      profile: {
        firstName: data.firstName,
        lastName: data.lastName,
        // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
      },
      status: "active",
    })
    .select()
    .single();

  if (error) throw error;

  // 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω (–∫–∞—Å—Ç–æ–º–Ω—ã–π, –Ω–µ Supabase)
  const token = generateJWT({
    projectUserId: user.id,
    projectId: projectId,
    email: user.email,
  });

  return {
    token,
    user: {
      id: user.id,
      email: user.email,
      profile: user.profile,
    },
  };
}
```

#### 2. –í—Ö–æ–¥

```typescript
// POST /api/public/[projectId]/auth/sign-in
async function signIn(
  projectId: string,
  data: {
    email: string;
    password: string;
  }
) {
  // 1. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ project_users –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
  const { data: user, error } = await supabase
    .from("project_users")
    .select("*")
    .eq("project_id", projectId)
    .eq("email", data.email)
    .eq("status", "active")
    .single();

  if (error || !user) {
    throw new Error("Invalid email or password");
  }

  // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
  const isValid = await bcrypt.compare(data.password, user.password_hash);
  if (!isValid) {
    throw new Error("Invalid email or password");
  }

  // 3. –û–±–Ω–æ–≤–ª—è–µ–º last_login_at
  await supabase
    .from("project_users")
    .update({ last_login_at: new Date().toISOString() })
    .eq("id", user.id);

  // 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
  const token = generateJWT({
    projectUserId: user.id,
    projectId: projectId,
    email: user.email,
  });

  return {
    token,
    user: {
      id: user.id,
      email: user.email,
      profile: user.profile,
    },
  };
}
```

#### 3. OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

```typescript
// POST /api/public/[projectId]/auth/oauth/[provider]
async function oauthSignIn(
  projectId: string,
  provider: "google" | "github",
  oauthData: {
    id: string;
    email: string;
    name?: string;
    avatar?: string;
  }
) {
  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –≤ project_users
  let user = await supabase
    .from("project_users")
    .select("*")
    .eq("project_id", projectId)
    .eq("email", oauthData.email)
    .single();

  if (!user) {
    // 2. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: newUser } = await supabase
      .from("project_users")
      .insert({
        project_id: projectId,
        email: oauthData.email,
        password_hash: "", // OAuth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∏–º–µ—é—Ç –ø–∞—Ä–æ–ª—è
        oauth_providers: {
          [provider]: {
            id: oauthData.id,
            email: oauthData.email,
          },
        },
        profile: {
          firstName: oauthData.name?.split(" ")[0],
          lastName: oauthData.name?.split(" ")[1],
          avatar: oauthData.avatar,
        },
        status: "active",
        email_verified: true, // OAuth email —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
      })
      .select()
      .single();

    user = newUser;
  } else {
    // 3. –û–±–Ω–æ–≤–ª—è–µ–º OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä
    const providers = user.oauth_providers || {};
    providers[provider] = {
      id: oauthData.id,
      email: oauthData.email,
    };

    await supabase
      .from("project_users")
      .update({
        oauth_providers: providers,
        last_login_at: new Date().toISOString(),
      })
      .eq("id", user.id);
  }

  // 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
  const token = generateJWT({
    projectUserId: user.id,
    projectId: projectId,
    email: user.email,
  });

  return {
    token,
    user: {
      id: user.id,
      email: user.email,
      profile: user.profile,
    },
  };
}
```

---

## üîë JWT —Ç–æ–∫–µ–Ω—ã

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–∞

```typescript
interface ProjectUserJWT {
  projectUserId: string; // ID –∏–∑ project_users
  projectId: string; // ID –ø—Ä–æ–µ–∫—Ç–∞
  email: string;
  iat: number; // Issued at
  exp: number; // Expiration
}
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞

```typescript
import jwt from "jsonwebtoken";

function generateJWT(payload: {
  projectUserId: string;
  projectId: string;
  email: string;
}): string {
  return jwt.sign(
    {
      projectUserId: payload.projectUserId,
      projectId: payload.projectId,
      email: payload.email,
    },
    process.env.JWT_SECRET!, // –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–æ–≤
    {
      expiresIn: "7d", // 7 –¥–Ω–µ–π
    }
  );
}
```

### –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞

```typescript
// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
async function verifyProjectUserToken(
  token: string,
  projectId: string
): Promise<ProjectUserJWT | null> {
  try {
    const decoded = jwt.verify(
      token,
      process.env.JWT_SECRET!
    ) as ProjectUserJWT;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    if (decoded.projectId !== projectId) {
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω
    const { data: user } = await supabase
      .from("project_users")
      .select("id, status")
      .eq("id", decoded.projectUserId)
      .eq("project_id", projectId)
      .single();

    if (!user || user.status !== "active") {
      return null;
    }

    return decoded;
  } catch (error) {
    return null;
  }
}
```

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ `created_by` –≤ –∫–æ–¥–µ

**–ë—ã–ª–æ:**

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ auth.users.id
const {
  data: { user },
} = await supabase.auth.getUser();
created_by: user?.id || null;
```

**–°—Ç–∞–ª–æ:**

```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º project_users.id –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞
const projectUser = await verifyProjectUserToken(token, projectId);
created_by: projectUser?.projectUserId || null;
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SDK

```typescript
// lib/sdk/public-api/client.ts
async createInstance(
  entityDefinitionId: string,
  data: CreateInstanceData
): Promise<EntityInstanceWithFields> {
  // 1. –ü–æ–ª—É—á–∞–µ–º projectUserId –∏–∑ —Ç–æ–∫–µ–Ω–∞ (–Ω–µ –∏–∑ auth.users)
  const projectUser = await this.getProjectUserFromToken();

  if (!projectUser) {
    throw new Error('Unauthorized');
  }

  // 2. –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å project_users.id
  const { data: instance, error } = await this.supabase
    .from('entity_instance')
    .insert({
      entity_definition_id: entityDefinitionId,
      project_id: this.projectId,
      data: instanceData,
      created_by: projectUser.projectUserId,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º project_users.id
    })
    .select()
    .single();

  // ...
}
```

---

## üìã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è project_users

```sql
-- –í–∫–ª—é—á–µ–Ω–∏–µ RLS
ALTER TABLE project_users ENABLE ROW LEVEL SECURITY;

-- –ü–æ–ª–∏—Ç–∏–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∑–∞–ø–∏—Å—å
CREATE POLICY "Users can view own project_user record"
  ON project_users
  FOR SELECT
  USING (
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ JWT —Ç–æ–∫–µ–Ω (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é)
    -- –ò–ª–∏ —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤ API
    id = current_project_user_id()
  );

-- –ü–æ–ª–∏—Ç–∏–∫–∞: –ê–¥–º–∏–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
CREATE POLICY "Project admins can view all project users"
  ON project_users
  FOR SELECT
  USING (
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ project_admins
    EXISTS (
      SELECT 1 FROM project_admins
      WHERE project_admins.project_id = project_users.project_id
        AND project_admins.user_id = auth.uid()  -- –î–ª—è –∞–¥–º–∏–Ω–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è auth.users
    )
  );

-- –ü–æ–ª–∏—Ç–∏–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Users can update own profile"
  ON project_users
  FOR UPDATE
  USING (id = current_project_user_id())
  WITH CHECK (id = current_project_user_id());

-- –ü–æ–ª–∏—Ç–∏–∫–∞: –ü—É–±–ª–∏—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—á–µ—Ä–µ–∑ API)
-- RLS –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API endpoint
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ auth.users

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ–Ω–æ—Å –≤ project_users**

```sql
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–∑–¥–∞–µ–º project_users –∏–∑ auth.users
INSERT INTO project_users (
  project_id,
  email,
  password_hash,  -- –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ auth.users (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
  profile,
  status
)
SELECT
  'project-id-here',
  au.email,
  '',  -- –ü–∞—Ä–æ–ª—å –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  jsonb_build_object(
    'firstName', p.first_name,
    'lastName', p.last_name,
    'avatar', p.avatar_url
  ),
  'active'
FROM auth.users au
LEFT JOIN profiles p ON p.id = au.id
WHERE au.email IS NOT NULL;
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥**

- –û—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ auth.users
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ project_users
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

---

## üìä –°—Ö–µ–º–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```mermaid
erDiagram
    auth_users ||--o{ admins : "can_be"
    auth_users ||--o{ project_admins : "can_be"

    projects ||--o{ project_users : "has"
    projects ||--o{ project_admins : "has"
    projects ||--o{ entity_instance : "has"

    project_users ||--o{ entity_instance : "creates"
    project_users ||--o{ entity_file : "uploads"
    project_users ||--o{ entity_relation : "creates"

    auth_users {
        uuid id PK
        string email UK
    }

    project_users {
        uuid id PK
        uuid project_id FK
        string email
        string password_hash
        jsonb oauth_providers
        jsonb profile
        string status
        UNIQUE project_id_email
    }

    entity_instance {
        uuid id PK
        uuid project_id FK
        uuid created_by FK "‚Üí project_users.id"
    }
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. ‚úÖ **–†–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏** - –∫–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π –ø–∞—Ä–æ–ª—å –¥–ª—è –æ–¥–Ω–æ–≥–æ email
2. ‚úÖ **–†–∞–∑–Ω—ã–µ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google –≤ –æ–¥–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ, GitHub –≤ –¥—Ä—É–≥–æ–º
3. ‚úÖ **–†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏** - –ø—Ä–æ—Ñ–∏–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `project_users.profile` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
4. ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã
5. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª–µ–π

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º `bcrypt` –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏–º –ø–∞—Ä–æ–ª–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: 8 —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏

### 2. JWT —Ç–æ–∫–µ–Ω—ã

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π `JWT_SECRET` –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–æ–≤
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤ (7 –¥–Ω–µ–π)
- ‚úÖ Refresh tokens –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

### 3. OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

- ‚úÖ –•—Ä–∞–Ω–∏–º OAuth –¥–∞–Ω–Ω—ã–µ –≤ `oauth_providers` JSONB
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email —á–µ—Ä–µ–∑ OAuth

### 4. –ú–∏–≥—Ä–∞—Ü–∏—è

- ‚ö†Ô∏è –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ `created_by` —Å—Å—ã–ª–∫–∏
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å SDK –∏ API endpoints

---

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è

1. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥?** (auth.users –¥–ª—è –∞–¥–º–∏–Ω–∫–∏, project_users –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
2. **JWT —Ç–æ–∫–µ–Ω—ã** - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ JWT –∏–ª–∏ Supabase JWT —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏?
3. **–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ auth.users?
4. **OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã** - –∫–∞–∫–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º? (Google, GitHub, Facebook, –∏ —Ç.–¥.)
5. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è** - –∫–∞–∫ —Ä–µ–∞–ª–∏–∑—É–µ–º –¥–ª—è project_users?

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** –ù–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–∏
