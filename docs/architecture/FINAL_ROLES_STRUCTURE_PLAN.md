# –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–æ–ª–µ–π (–æ–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞)

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `project_admins` –¥–ª—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤

### –ü—Ä–∏–Ω—Ü–∏–ø:

- **–í—Å–µ –∞–¥–º–∏–Ω—ã** (superAdmin, projectSuperAdmin, projectAdmin) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `project_admins`
- **superAdmin** –∏–º–µ–µ—Ç `project_id = NULL` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º)
- **projectSuperAdmin** –∏ **projectAdmin** –∏–º–µ—é—Ç `project_id = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç` (–¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º)

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `admin_roles` (—Ä–æ–ª–∏)

```sql
admin_roles
‚îú‚îÄ‚îÄ id (UUID)
‚îú‚îÄ‚îÄ name (TEXT) -- 'superAdmin', 'projectSuperAdmin', 'projectAdmin'
‚îú‚îÄ‚îÄ description (TEXT)
‚îî‚îÄ‚îÄ created_at (TIMESTAMP)
```

**–†–æ–ª–∏:**

- `superAdmin` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω (–¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º)
- `projectSuperAdmin` - —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞ (–¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º)
- `projectAdmin` - –∞–¥–º–∏–Ω –ø—Ä–æ–µ–∫—Ç–∞ (–¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º)

### –¢–∞–±–ª–∏—Ü–∞ `project_admins` (–≤—Å–µ –∞–¥–º–∏–Ω—ã)

```sql
project_admins
‚îú‚îÄ‚îÄ id (UUID)
‚îú‚îÄ‚îÄ project_id (UUID) ‚Üí projects (NULL –¥–ª—è superAdmin)
‚îú‚îÄ‚îÄ user_id (UUID) ‚Üí auth.users
‚îú‚îÄ‚îÄ role_id (UUID) ‚Üí admin_roles
‚îú‚îÄ‚îÄ created_at (TIMESTAMP)
‚îî‚îÄ‚îÄ updated_at (TIMESTAMP)
```

**–õ–æ–≥–∏–∫–∞:**

- **superAdmin:** `project_id = NULL` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- **projectSuperAdmin/projectAdmin:** `project_id = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç`

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**

- `UNIQUE (user_id, project_id)` - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –¢—Ä–∏–≥–≥–µ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏: superAdmin –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å `project_id = NULL`

---

## üìä –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

| –†–æ–ª—å                | –ü—Ä–æ–µ–∫—Ç—ã                    | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏ | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö |
| ------------------- | -------------------------- | -------------------- | ------------------- | ------------------------ | --------------------- |
| `superAdmin`        | –í—Å–µ (project_id = NULL)    | ‚úÖ                   | ‚úÖ (–≤—Å–µ)            | ‚úÖ (–≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã)         | ‚úÖ (–≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã)      |
| `projectSuperAdmin` | –°–≤–æ–∏ (project_id = –ø—Ä–æ–µ–∫—Ç) | ‚ùå                   | ‚úÖ (—Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç)    | ‚úÖ (—Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç)         | ‚úÖ (—Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç)      |
| `projectAdmin`      | –°–≤–æ–∏ (project_id = –ø—Ä–æ–µ–∫—Ç) | ‚ùå                   | ‚ùå                  | ‚ùå (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)       | ‚úÖ (—Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç)      |
| –ù–µ—Ç —Ä–æ–ª–∏            | ‚ùå                         | ‚ùå                   | ‚ùå                  | ‚ùå                       | ‚ùå                    |

---

## üîÑ –§–ª–æ—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π

### 1. Middleware: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∞

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ project_admins (–ª—é–±–∞—è —Ä–æ–ª—å)
const isAdmin = await supabase.rpc("is_any_admin", { user_uuid: userId });

if (!isAdmin) {
  redirect("/welcome");
}
```

### 2. Layout: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

```typescript
// –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
const projectIds = await supabase.rpc("get_accessible_project_ids", {
  user_uuid: userId,
});

// –õ–æ–≥–∏–∫–∞:
// - superAdmin ‚Üí –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
// - –ò–Ω–∞—á–µ ‚Üí –ø—Ä–æ–µ–∫—Ç—ã –∏–∑ project_admins
```

### 3. Project Layout: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—É
const projectRole = await supabase.rpc("get_user_project_role", {
  p_project_id: projectId,
  p_user_id: userId,
});

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 'superAdmin' | 'projectSuperAdmin' | 'projectAdmin' | null
```

---

## üîß SQL –§—É–Ω–∫—Ü–∏–∏

### `is_any_admin(user_uuid UUID)`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª—é–±—ã–º –∞–¥–º–∏–Ω–æ–º (–ª—é–±–∞—è —Ä–æ–ª—å –≤ project_admins)

### `is_super_admin(user_uuid UUID)`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å superAdmin (project_id = NULL)

### `get_user_role(user_uuid UUID)`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ä–æ–ª—å: 'superAdmin', 'admin' (–ª—é–±–æ–π –∞–¥–º–∏–Ω) –∏–ª–∏ 'user'

### `get_user_project_role(p_project_id UUID, p_user_id UUID)`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ–µ–∫—Ç–µ: 'superAdmin', 'projectSuperAdmin', 'projectAdmin' –∏–ª–∏ NULL

### `get_accessible_project_ids(user_uuid UUID)`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ ID –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –î–ª—è superAdmin - –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –∏–∑ project_admins

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞** - –ø—Ä–æ—â–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. **–ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞** - –≤—Å–µ –∞–¥–º–∏–Ω—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
3. **–ì–∏–±–∫–æ—Å—Ç—å** - superAdmin —á–µ—Ä–µ–∑ `project_id = NULL`
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
5. **–Ø—Å–Ω–æ—Å—Ç—å** - –ø–æ–Ω—è—Ç–Ω–æ, –≥–¥–µ –≤—Å–µ –∞–¥–º–∏–Ω—ã

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **superAdmin:** `project_id = NULL` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø)
2. **–ü—Ä–æ–µ–∫—Ç–Ω—ã–µ —Ä–æ–ª–∏:** `project_id = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç`
3. **UNIQUE constraint:** `(user_id, project_id)` - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
4. **–¢—Ä–∏–≥–≥–µ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏:** superAdmin –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å `project_id = NULL`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
