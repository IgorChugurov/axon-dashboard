# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üî¥ –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ø—Ä–æ–±–ª–µ–º—ã)

### –°—Ö–µ–º–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–¥–∏–Ω —Ä–µ–Ω–¥–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã:

```
HTTP Request ‚Üí /dashboard
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MIDDLEWARE                                               ‚îÇ
‚îÇ 1. updateSession() ‚Üí getUser()                          ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ Supabase Auth API                      ‚îÇ
‚îÇ 2. getUserRoleCached() ‚Üí getUserRole()                 ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ –ë–î (get_user_role RPC)                ‚îÇ
‚îÇ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LAYOUT.TSX (Server Component)                          ‚îÇ
‚îÇ 1. getServerUser() ‚Üí getUser()                         ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ Supabase Auth API (–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!)     ‚îÇ
‚îÇ 2. getServerUser() ‚Üí getUserRole()                     ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ –ë–î (–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!)                     ‚îÇ
‚îÇ 3. –ü–µ—Ä–µ–¥–∞–µ—Ç initialUser –≤ AuthProvider                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AUTH PROVIDER (Client Component)                       ‚îÇ
‚îÇ 1. –ü–æ–ª—É—á–∞–µ—Ç initialUser (–æ—Ç Layout)                    ‚îÇ
‚îÇ 2. –ù–û –¢–ê–ö–ñ–ï –≤—ã–∑—ã–≤–∞–µ—Ç getSession()                     ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ Supabase (–ò–ó–ë–´–¢–û–ß–ù–û!)                  ‚îÇ
‚îÇ 3. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ onAuthStateChange                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PAGE.TSX (Server Component)                            ‚îÇ
‚îÇ 1. getUser() ‚Üí –ó–∞–ø—Ä–æ—Å –∫ Supabase (–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!)      ‚îÇ
‚îÇ 2. getUserRole() ‚Üí –ó–∞–ø—Ä–æ—Å –∫ –ë–î (–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!)        ‚îÇ
‚îÇ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ (–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï –ø—Ä–æ–≤–µ—Ä–∫–∏!)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ò–¢–û–ì–û: 5-6 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–¥–∏–Ω —Ä–µ–Ω–¥–µ—Ä!
```

### –ü—Ä–æ–±–ª–µ–º—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

#### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚ùå **5-6 –∑–∞–ø—Ä–æ—Å–æ–≤** –Ω–∞ –æ–¥–∏–Ω —Ä–µ–Ω–¥–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤** –∫ Supabase –∏ –ë–î
- ‚ùå **–ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä** –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö await
- ‚ùå **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î** –æ—Ç —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `get_user_role`

#### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚ùå **–ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤–¥—ã** - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏** –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –≤ 3 –º–µ—Å—Ç–∞—Ö
- ‚ùå **–ù–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö** –∏–∑ middleware –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚ùå **–ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å** –≤ AuthProvider (initialUser + getSession)

#### 3. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚ùå **–ö–µ—à –≤ –ø–∞–º—è—Ç–∏** –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–∞
- ‚ùå **TTL 5 –º–∏–Ω—É—Ç** –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
- ‚ùå **–ù–µ—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏** –∫–µ—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏

---

## ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ö–µ–º–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

```
HTTP Request ‚Üí /dashboard
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MIDDLEWARE                                               ‚îÇ
‚îÇ 1. updateSession() ‚Üí getUser()                          ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ Supabase Auth API                      ‚îÇ
‚îÇ 2. getUserRoleCached() ‚Üí getUserRole()                 ‚îÇ
‚îÇ    ‚îî‚îÄ> –ó–∞–ø—Ä–æ—Å –∫ –ë–î (get_user_role RPC)                ‚îÇ
‚îÇ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ                 ‚îÇ
‚îÇ 4. ‚úÖ –£–°–¢–ê–ù–û–í–ö–ê HEADERS:                               ‚îÇ
‚îÇ    - x-user-id                                          ‚îÇ
‚îÇ    - x-user-role                                        ‚îÇ
‚îÇ    - x-user-email                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LAYOUT.TSX (Server Component)                          ‚îÇ
‚îÇ ‚úÖ –ß–ò–¢–ê–ï–¢ –ò–ó HEADERS (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤!)                   ‚îÇ
‚îÇ 1. getServerUserFromHeaders()                          ‚îÇ
‚îÇ    ‚îî‚îÄ> –ß–∏—Ç–∞–µ—Ç x-user-id, x-user-role, x-user-email     ‚îÇ
‚îÇ 2. –ü–µ—Ä–µ–¥–∞–µ—Ç initialUser –≤ AuthProvider                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AUTH PROVIDER (Client Component)                       ‚îÇ
‚îÇ ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢ initialUser (–±–µ–∑ getSession!)             ‚îÇ
‚îÇ 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ initialUser              ‚îÇ
‚îÇ 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ onAuthStateChange (—Ç–æ–ª—å–∫–æ –¥–ª—è      ‚îÇ
‚îÇ    —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π)                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PAGE.TSX (Server Component)                            ‚îÇ
‚îÇ ‚úÖ –ß–ò–¢–ê–ï–¢ –ò–ó HEADERS (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤!)                   ‚îÇ
‚îÇ 1. getServerUserFromHeaders()                          ‚îÇ
‚îÇ    ‚îî‚îÄ> –ß–∏—Ç–∞–µ—Ç x-user-id, x-user-role                   ‚îÇ
‚îÇ 2. ‚úÖ –£–ë–†–ê–ù–ê –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ (middleware —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ò–¢–û–ì–û: 2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–¥–∏–Ω —Ä–µ–Ω–¥–µ—Ä (—Ç–æ–ª—å–∫–æ –≤ middleware)!
```

### –£–ª—É—á—à–µ–Ω–∏—è:

#### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤**: —Å 5-6 –¥–æ 2 (—Ç–æ–ª—å–∫–æ –≤ middleware)
- ‚úÖ **–£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∞**: –Ω–∞ 50-70%
- ‚úÖ **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î**: —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å `get_user_role`
- ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ Time to First Byte (TTFB)**

#### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã**: –¥–∞–Ω–Ω—ã–µ –∏–∑ middleware
- ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ —Ç–æ–ª—å–∫–æ –≤ middleware
- ‚úÖ **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö**: —á–µ—Ä–µ–∑ headers
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AuthProvider**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç initialUser

#### 3. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∫–µ—à**: Next.js cache –∏–ª–∏ Redis
- ‚úÖ **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π TTL**: 1-2 –º–∏–Ω—É—Ç—ã
- ‚úÖ **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞**: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

| –û–ø–µ—Ä–∞—Ü–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ | –í—Ä–µ–º—è (–ø—Ä–∏–º–µ—Ä–Ω–æ) |
|----------|-------------------|------------------|
| Middleware | 2 (getUser + getRole) | 50-100ms |
| Layout | 2 (getUser + getRole) | 50-100ms |
| AuthProvider | 1 (getSession) | 20-50ms |
| Page | 2 (getUser + getRole) | 50-100ms |
| **–ò–¢–û–ì–û** | **7 –∑–∞–ø—Ä–æ—Å–æ–≤** | **170-350ms** |

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

| –û–ø–µ—Ä–∞—Ü–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ | –í—Ä–µ–º—è (–ø—Ä–∏–º–µ—Ä–Ω–æ) |
|----------|-------------------|------------------|
| Middleware | 2 (getUser + getRole) | 50-100ms |
| Layout | 0 (—á–∏—Ç–∞–µ—Ç headers) | <1ms |
| AuthProvider | 0 (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç initialUser) | <1ms |
| Page | 0 (—á–∏—Ç–∞–µ—Ç headers) | <1ms |
| **–ò–¢–û–ì–û** | **2 –∑–∞–ø—Ä–æ—Å–∞** | **50-100ms** |

**–£–ª—É—á—à–µ–Ω–∏–µ: 70% –±—ã—Å—Ç—Ä–µ–µ, 71% –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤**

---

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```typescript
// middleware.ts
const { response, user } = await updateSession(request); // –ó–∞–ø—Ä–æ—Å 1

// layout.tsx
const user = await getServerUser(); // –ó–∞–ø—Ä–æ—Å 2 (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)

// AuthProvider.tsx
supabase.auth.getSession().then(...); // –ó–∞–ø—Ä–æ—Å 3 (–∏–∑–±—ã—Ç–æ—á–Ω–æ!)

// page.tsx
const { data: { user } } = await supabase.auth.getUser(); // –ó–∞–ø—Ä–æ—Å 4 (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)
```

**–†–µ—à–µ–Ω–∏–µ:**

```typescript
// middleware.ts
const { response, user } = await updateSession(request);
response.headers.set("x-user-id", user.id);
response.headers.set("x-user-role", userRole);

// layout.tsx
const user = await getServerUserFromHeaders(); // –ß–∏—Ç–∞–µ—Ç headers, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤!

// AuthProvider.tsx
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç initialUser, –±–µ–∑ getSession()

// page.tsx
const user = await getServerUserFromHeaders(); // –ß–∏—Ç–∞–µ—Ç headers, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤!
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```typescript
// middleware.ts
const userRole = await getUserRoleCached(user.id);
if (userRole === "user" && !pathname.startsWith("/welcome")) {
  return NextResponse.redirect("/welcome"); // –†–µ–¥–∏—Ä–µ–∫—Ç
}

// page.tsx
const userRole = await getUserRole(user.id); // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
if (userRole === "user") {
  redirect("/welcome"); // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞!
}
```

**–†–µ—à–µ–Ω–∏–µ:**

```typescript
// middleware.ts
const userRole = await getUserRoleCached(user.id);
if (userRole === "user" && !pathname.startsWith("/welcome")) {
  return NextResponse.redirect("/welcome");
}
response.headers.set("x-user-role", userRole);

// page.tsx
// –£–ë–†–ê–¢–¨ –ø—Ä–æ–≤–µ—Ä–∫—É - middleware —É–∂–µ —Å–¥–µ–ª–∞–ª —Ä–µ–¥–∏—Ä–µ–∫—Ç
// –î–æ–≤–µ—Ä—è–µ–º middleware
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å –≤ AuthProvider

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```typescript
// AuthProvider.tsx
useEffect(() => {
  // –ü–æ–ª—É—á–∞–µ—Ç initialUser –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
  // –ù–û –¢–ê–ö–ñ–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –∑–∞–Ω–æ–≤–æ!
  supabase.auth.getSession().then(({ data: { session } }) => {
    const user = transformSupabaseUser(session?.user ?? null);
    setAuthState({ user, ... });
  });
}, []);
```

**–†–µ—à–µ–Ω–∏–µ:**

```typescript
// AuthProvider.tsx
useEffect(() => {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º initialUser –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
  if (initialUser) {
    setAuthState({
      user: initialUser,
      isAuthenticated: true,
      isLoading: false,
    });
  } else {
    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç initialUser, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é
    supabase.auth.getSession().then(...);
  }
}, [initialUser]);
```

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏):

1. ‚úÖ **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ headers** - —É–±–∏—Ä–∞–µ—Ç 3-4 –∑–∞–ø—Ä–æ—Å–∞
2. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∏–µ AuthProvider** - —É–±–∏—Ä–∞–µ—Ç 1 –∑–∞–ø—Ä–æ—Å

**–≠—Ñ—Ñ–µ–∫—Ç:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å 7 –¥–æ 2 (71% —É–ª—É—á—à–µ–Ω–∏–µ)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—É–ª—É—á—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É):

3. ‚úÖ **–£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫** - —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥
4. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è** - —É–ª—É—á—à–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–≠—Ñ—Ñ–µ–∫—Ç:** –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞, –ª—É—á—à–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (nice to have):

5. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∏–µ API routes** - –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–≠—Ñ—Ñ–µ–∫—Ç:** –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ–¥—Ö–æ–¥–∞

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (2-3 —á–∞—Å–∞)
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å middleware –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ headers
- [ ] –°–æ–∑–¥–∞—Ç—å `getServerUserFromHeaders()`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å Layout.tsx
- [ ] –£–ø—Ä–æ—Å—Ç–∏—Ç—å AuthProvider

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 71% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### –≠—Ç–∞–ø 2: –£–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (1-2 —á–∞—Å–∞)
- [ ] –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏–∑ Page
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞

### –≠—Ç–∞–ø 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 —á–∞—Å–∞)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å API routes
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–µ—à–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å headers:**
   - Headers —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ middleware
   - –ù–µ –¥–æ–≤–µ—Ä—è—Ç—å headers –≤ API routes –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT
   - –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Authorization header

2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –ò–∑–º–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ/–ø–æ—Å–ª–µ
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

